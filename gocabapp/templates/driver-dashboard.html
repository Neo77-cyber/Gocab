{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Dashboard - Modern Admin Panel</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Favicons -->
  <link href="" rel="icon">
  <link href="" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
	/* Global Variables and Base Styles */
	:root {
	  --primary-color: #08915e;
	  --primary-light: #e6f7f0;
	  --sidebar-width: 280px;
	  --transition: all 0.3s ease;
	}
	
	* {
	  margin: 0;
	  padding: 0;
	  box-sizing: border-box;
	}
	
	body {
	  font-family: 'Inter', sans-serif;
	  background-color: #f8fafc;
	  color: #333;
	  display: flex;
	  min-height: 100vh;
	}
  
	/* Sidebar Styles */
	#sidebar {
	  width: var(--sidebar-width);
	  background: white;
	  height: 100vh;
	  position: fixed;
	  top: 0;
	  left: 0;
	  box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
	  transition: var(--transition);
	  z-index: 1000;
	  padding: 1.5rem;
	  overflow-y: auto;
	}
	
	.sidebar-header {
	  display: flex;
	  align-items: center;
	  margin-bottom: 2.5rem;
	  padding-bottom: 1.5rem;
	  border-bottom: 1px solid #eee;
	}
	
	.sidebar-logo {
	  font-size: 1.5rem;
	  font-weight: 700;
	  color: var(--primary-color);
	  text-decoration: none;
	  display: flex;
	  align-items: center;
	}
	
	.sidebar-logo i {
	  margin-right: 0.75rem;
	  font-size: 1.75rem;
	}
	
	.sidebar-menu {
	  list-style: none;
	}
	
	.menu-title {
	  font-size: 0.75rem;
	  text-transform: uppercase;
	  letter-spacing: 0.1em;
	  color: #64748b;
	  margin: 1.5rem 0 0.75rem;
	  font-weight: 600;
	}
	
	.menu-item {
	  margin-bottom: 0.5rem;
	  position: relative;
	}
/* Pagination Styles */
.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 25px 0 15px 0;
    padding: 20px 0;
    border-top: 1px solid #e2e8f0;
    border-bottom: 1px solid #e2e8f0;
    flex-wrap: wrap;
    gap: 15px;
}

.page-numbers {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
}

.page-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    border: 1px solid #d1d5db;
    background: white;
    color: #82b8a1;
    text-decoration: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
    cursor: pointer;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.page-link:hover {
    background: #08915E;  
    color: white;
    border-color: #08915E;  
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(8, 145, 94, 0.2);  
}

.page-link.current {
    background: #08915E;  
    color: white;
    border-color: #08915E;  
    cursor: default;
    transform: none;
    box-shadow: 0 2px 4px rgba(8, 145, 94, 0.2);  
}

.page-link:active {
    transform: translateY(0);
}

.page-link i {
    font-size: 12px;
}

/* Previous/Next buttons specific styles */
.pagination > .page-link:first-child,
.pagination > .page-link:last-child {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0);
    border: 1px solid #cbd5e0;
    font-weight: 600;
    color: #82b8a1;
}

.pagination > .page-link:first-child:hover,
.pagination > .page-link:last-child:hover {
    background: linear-gradient(135deg, #08915E, #067a4e);  
    border-color: #067a4e;  
    color: white;
}

.pagination-info {
    text-align: center;
    color: #08915E;
    font-size: 14px;
    margin-top: 10px;
    padding: 12px 16px;
    /* Background removed as requested */
    border-radius: 8px;
    font-weight: 500;
}

/* Loading state for pagination */
.pagination.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Empty state styling */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #82b8a1;
    background: #f9fafb;
    border-radius: 12px;
    border: 2px dashed #d1d5db;
    margin: 20px 0;
}

.empty-state i {
    font-size: 48px;
    color: #82b8a1;
    margin-bottom: 16px;
    display: block;
}

.empty-state p {
    font-size: 16px;
    margin: 0;
    font-weight: 500;
}

/* Responsive Design */
@media (max-width: 768px) {
    .pagination {
        flex-direction: column;
        gap: 12px;
        padding: 15px 0;
    }
    
    .page-numbers {
        order: 2;
    }
    
    .pagination > .page-link:first-child,
    .pagination > .page-link:last-child {
        order: 1;
        width: 100%;
        justify-content: center;
    }
    
    .page-link {
        padding: 8px 12px;
        font-size: 13px;
    }
    
    .pagination-info {
        font-size: 13px;
        padding: 10px 12px;
    }
}

@media (max-width: 480px) {
    .page-numbers {
        gap: 4px;
    }
    
    .page-link {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 36px;
        justify-content: center;
    }
    
    .page-link i {
        font-size: 10px;
    }
}

/* Animation for page transitions */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.pagination {
    animation: fadeIn 0.3s ease-in-out;
}

/* Focus states for accessibility */
.page-link:focus {
    outline: 2px solid #08915E; /* Changed from #007bff to #08915E */
    outline-offset: 2px;
}

/* Dark mode support (optional) */
@media (prefers-color-scheme: dark) {
    .page-link {
        background: #374151;
        border-color: #4b5563;
        color: #82b8a1;
    }
    
    .page-link:hover {
        background: #08915E; /* Changed from #007bff to #08915E */
        color: white;
        border-color: #08915E; /* Changed from #007bff to #08915E */
    }
    
    .pagination-info {
        background: transparent;
        border-color: transparent;
        color: #82b8a1;
    }
    
    .empty-state {
        background: #374151;
        border-color: #4b5563;
        color: #82b8a1;
    }
}
	
	.menu-link {
	  display: flex;
	  align-items: center;
	  padding: 0.75rem 1rem;
	  border-radius: 0.5rem;
	  color: #64748b;
	  text-decoration: none;
	  font-weight: 500;
	  transition: var(--transition);
	}
	
	.menu-link:hover {
	  background-color: var(--primary-light);
	  color: var(--primary-color);
	}
	
	.menu-link.active {
	  background-color: var(--primary-light);
	  color: var(--primary-color);
	  font-weight: 600;
	}
	
	.menu-link i {
	  margin-right: 0.75rem;
	  font-size: 1.1rem;
	  width: 24px;
	  text-align: center;
	}
	
	.menu-badge {
	  margin-left: auto;
	  background-color: var(--primary-color);
	  color: white;
	  font-size: 0.7rem;
	  padding: 0.2rem 0.5rem;
	  border-radius: 10px;
	  animation: bounce 1s infinite alternate;
	}
  
	/* Main Content Area */
	main {
	  margin-left: var(--sidebar-width);
	  flex-grow: 1;
	  padding: 2rem;
	  transition: var(--transition);
	}
	
	.page-header {
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  margin-bottom: 2rem;
	}
	
	.page-title {
	  font-size: 1.75rem;
	  font-weight: 600;
	  color: #1e293b;
	}
  
	/* Dashboard Layout */
	.trips-dashboard {
	  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
	  color: #333;
	  padding: 20px;
	  max-width: 1200px;
	  margin: 0 auto;
	}
	
	/* Tab Navigation */
	.trip-tabs {
	  display: flex;
	  border-bottom: 1px solid #e0e0e0;
	  margin-bottom: 20px;
	  overflow-x: auto;
	  scrollbar-width: none;
	}
	
	.trip-tabs::-webkit-scrollbar {
	  display: none;
	}
	
	.tab-btn {
	  padding: 12px 20px;
	  border: none;
	  background: none;
	  font-weight: 500;
	  font-size: 16px;
	  color: #666;
	  cursor: pointer;
	  position: relative;
	  display: flex;
	  align-items: center;
	  gap: 8px;
	  white-space: nowrap;
	}
	
	.tab-btn.active {
	  color: var(--primary-color);
	  font-weight: 600;
	  background-color: var(--primary-light);
	}
	
	.tab-btn.active::after {
	  content: '';
	  position: absolute;
	  bottom: -1px;
	  left: 0;
	  right: 0;
	  height: 3px;
	  background: var(--primary-color);
	}
	
	.badge {
	  background: var(--primary-color);
	  color: white;
	  border-radius: 10px;
	  padding: 2px 8px;
	  font-size: 12px;
	  font-weight: 500;
	}
  
	/* Ride Containers Grid */
	#pendingRidesContainer,
	#acceptedRidesContainer,
	#activeRidesContainer {
	  display: grid;
	  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
	  gap: 1.25rem;
	  margin-top: 1rem;
	}
  
	/* Section Management */
	.trip-section {
	  display: none;
	}
	
	.trip-section.active {
	  display: block;
	}
  
	/* Connection Status */
	.connection-status {
	  position: fixed;
	  bottom: 1.5rem;
	  right: 1.5rem;
	  background: white;
	  padding: 0.5rem 1rem;
	  border-radius: 50px;
	  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
	  display: flex;
	  align-items: center;
	  gap: 0.5rem;
	  font-size: 0.85rem;
	  z-index: 100;
	}
	
	.status-dot {
	  width: 10px;
	  height: 10px;
	  border-radius: 50%;
	  background: #ccc;
	  animation: pulse 1.5s infinite;
	}
	
	.status-dot.connected {
	  background: var(--primary-color);
	  animation: none;
	}
  
	/* Animations */
	@keyframes pulse {
	  0% { opacity: 1; }
	  50% { opacity: 0.3; }
	  100% { opacity: 1; }
	}
  
	@keyframes bounce {
	  from { transform: translateY(0); }
	  to { transform: translateY(-3px); }
	}
  
	/* Responsive Adjustments */
	@media (max-width: 768px) {
	  main {
		padding: 1rem;
	  }
	  
	  .trips-dashboard {
		padding: 0;
	  }
	  
	  #pendingRidesContainer,
	  #acceptedRidesContainer,
	  #activeRidesContainer {
		grid-template-columns: 1fr;
	  }
	}
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-header">
      <a href="#" class="sidebar-logo">
        <i class="fas fa-car"></i>  
        <span>GoCab</span>
      </a>
    </div>

    <ul class="sidebar-menu">
      <li class="menu-title">MAIN</li>
      
      <li class="menu-item">
        <a href="{% url 'driver_dashboard' %}" class="menu-link">
          <i class="fas fa-home"></i>
          <span>Overview</span>
        </a>
      </li>
	  <li class="menu-item">
        <a href="{% url 'driver_profile' %}" class="menu-link">
		<i class="fas fa-user"></i>
          <span>Profile</span>
        </a>
      </li>
	  <li class="menu-item">
        <a href="{% url 'driver_earnings' %}" class="menu-link">
		<i class="fas fa-wallet"></i>
          <span>Earnings</span>
        </a>
      </li>
      
      
	  <li class="menu-item">
        <a href="#" class="menu-link active">
            <i class="fas fa-bell"></i>  
          <span>Notification</span>
          <span class="menu-badge">12</span>
        </a>
      </li>

      <li class="menu-title">SETTINGS</li>
      
      
      
      <li class="menu-item">
        <a href="{% url 'logout' %}" class="menu-link">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </li>
      
     

      
    </ul>
  </div>

  <!-- Main Content -->
  <main>
    <div class="page-header">
      
    </div>

	<div class="trips-dashboard">
		<!-- Trip Status Tabs -->
		<div class="trip-tabs">
			<button class="tab-btn active" data-tab="new-trips">New Requests <span id="newRequestsBadge" class="badge">{{ new_requests }}</span></button>
			<button class="tab-btn" data-tab="starting-trips">Starting Trip <span id="acceptedRidesBadge" class="badge">{{ accepted_rides|length }}</span></button>
			<button class="tab-btn" data-tab="active-trips">Active Trips <span id="activeTripsBadge" class="badge">{{ active_trips }}</span></button>
			<button class="tab-btn" data-tab="completed-trips">Completed <span class="badge">{{ completed_trips}}</span></button>
		</div>
	  
		<!-- New Trips Section -->
		<div class="trip-section active" id="new-trips">
			<div id="pendingRidesContainer">
				{% include 'partials/_pending_rides.html' %}
			</div>
		</div>
	
		<!-- Starting Trip Section -->
		<div class="trip-section" id="starting-trips">
			<div id="acceptedRidesContainer">
				{% include 'partials/_accepted_rides.html' %}
			</div>
		</div>
	
		<!-- Active Trips Section -->
		<div class="trip-section" id="active-trips">
			<div id="activeRidesContainer">
				{% include 'partials/_active_rides.html' %}
			</div>
		</div>

		<!-- Active Trips Section -->
		<div class="trip-section" id="completed-trips">
			<div id="completedRidesContainer">
				{% include 'partials/_completed_rides.html' %}
			</div>
		</div>

	</div>
	
	<!-- WebSocket Status Indicator -->
	<div id="connectionStatus" class="connection-status">
		<span class="status-dot"></span>
		<span class="status-text">Connecting...</span>
	</div>
	  
	  
		
      
   
  </main>

 <script>
	document.addEventListener('DOMContentLoaded', function() {
		// Initialize WebSocket connection
		const driverSocket = new WebSocket(
			`ws://${window.location.host}/ws/driver/updates/`
		);
	
		// Connection status UI
		const connectionStatus = document.getElementById('connectionStatus');
		const statusDot = connectionStatus.querySelector('.status-dot');
		const statusText = connectionStatus.querySelector('.status-text');
	
		// WebSocket event handlers
		driverSocket.onopen = function() {
			statusDot.classList.add('connected');
			statusText.textContent = 'Connected';
			console.log('WebSocket connection established');
		};
	
		driverSocket.onerror = function(error) {
			statusDot.classList.remove('connected');
			statusText.textContent = 'Connection error';
			console.error('WebSocket error:', error);
		};
	
		driverSocket.onclose = function() {
			statusDot.classList.remove('connected');
			statusText.textContent = 'Disconnected - Reconnecting...';
			setTimeout(() => window.location.reload(), 5000);
		};
	
		driverSocket.onmessage = function(event) {
			const data = JSON.parse(event.data);
			console.log('WebSocket message received:', data);
			
			// Handle different event types - use consistent property name
			const eventType = data.event || data.type;
			
			switch(eventType) {
				case 'new_ride_request':
					console.log('New ride request received');
					updatePendingRides();
					break;
					
				case 'ride_accepted':
					console.log('Ride accepted event received');
					if (data.ride && data.ride.driver_id !== {{ request.user.id }}) {
						updatePendingRides();
					}
					break;
		
				case 'ride_update':
					console.log('Ride update event received:', data);
					// Handle ride status updates
					if (data.status) {
						switch(data.status) {
							case 'accepted':
								console.log('Ride status: accepted');
								updatePendingRides();
								updateAcceptedRides();
								break;
							case 'started':
								console.log('Ride status: started');
								updateAcceptedRides();
								updateActiveRides();
								break;
							case 'completed':
								console.log('Ride status: completed');
								updateActiveRides();
								updateCompletedRides();
								if (data.driver && data.driver.id === {{ request.user.id }}) {
									
									setTimeout(() => {
										const completedTab = document.querySelector('[data-tab="completed-trips"]');
										if (completedTab && !completedTab.classList.contains('active')) {
											completedTab.click();
										}
									}, 500);
								}
								break;
							default:
								console.log('Unknown ride status:', data.status);
						}
					}
					break;
				
				case 'completed':  // Handle direct completed event
					console.log('Ride completed event received');
					updateActiveRides();
					updateCompletedRides();
					// Auto-switch to completed tab if it's for this driver
					if (data.driver && data.driver.id === {{ request.user.id }}) {
						setTimeout(() => {
							const completedTab = document.querySelector('[data-tab="completed-trips"]');
							if (completedTab && !completedTab.classList.contains('active')) {
								completedTab.click();
							}
						}, 500);
					}
					break;
					
				case 'heartbeat_ack':
					// Silent heartbeat acknowledgment
					break;
					
				default:
					console.log('Unknown WebSocket event type:', eventType);
			}
		};

		
    setInterval(() => {
        if (driverSocket.readyState === WebSocket.OPEN) {
            driverSocket.send(JSON.stringify({type: 'heartbeat'}));
        }
    }, 30000);
	
		// Tab switching functionality
		document.querySelectorAll('.tab-btn').forEach(btn => {
			btn.addEventListener('click', function() {
				const tabId = this.getAttribute('data-tab');
				
				// Update active tab
				document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
				this.classList.add('active');
				
				// Show corresponding section
				document.querySelectorAll('.trip-section').forEach(section => {
					section.classList.remove('active');
				});
				document.getElementById(tabId).classList.add('active');
			});
		});
	
		function updatePendingRides() {
			fetch('/driver/pending-rides/', {
				headers: {
					'X-Requested-With': 'XMLHttpRequest'
				}
			})
			.then(response => {
				if (!response.ok) throw new Error('Network response was not ok');
				return response.json();
			})
			.then(data => {
				const container = document.getElementById('pendingRidesContainer');
				container.innerHTML = data.html;
				updateBadge('newRequestsBadge', container.querySelectorAll('.trip-card').length);
				attachAcceptHandlers();
			})
			.catch(error => {
				console.error('Error fetching pending rides:', error);
			});
		}
	
		// Function to update accepted rides
		function updateAcceptedRides() {
			fetch('/driver/accepted-rides/')
				.then(response => response.json())
				.then(data => {
					document.getElementById('acceptedRidesContainer').innerHTML = data.html;
					updateBadge('acceptedRidesBadge', document.querySelectorAll('#acceptedRidesContainer .trip-card').length);
					attachStartHandlers();
				})
				.catch(error => {
					console.error('Error fetching accepted rides:', error);
				});
		}
	
		function updateActiveRides() {
			fetch('/driver/active-rides/')
				.then(response => response.json())
				.then(data => {
					document.getElementById('activeRidesContainer').innerHTML = data.html;
					updateBadge('activeTripsBadge', document.querySelectorAll('#activeRidesContainer .trip-card').length);
					// IMPORTANT: Attach complete handlers after updating content
					attachCompleteHandlers();
				})
				.catch(error => {
					console.error('Error fetching active rides:', error);
				});
		}

		function updateCompletedRides() {
			fetch('/driver/completed-trips/')
				.then(response => response.json())
				.then(data => {
					const container = document.getElementById('completedRidesContainer');
            			container.innerHTML = data.html;
            
					const completedBadge = document.querySelector('#completed-trips .badge');
					if (completedBadge) {
							completedBadge.textContent = container.querySelectorAll('.trip-card').length;
						}
				})
				.catch(error => {
					console.error('Error fetching completed rides:', error);
				});
		}
	
		// Helper function to update badge counts
		function updateBadge(badgeId, count) {
			const badge = document.getElementById(badgeId);
			if (badge) {
				badge.textContent = count;
				if (count > 0) {
					badge.classList.add('has-items');
				} else {
					badge.classList.remove('has-items');
				}
			}
		}

		
	
		function attachAcceptHandlers() {
			document.querySelectorAll('.accept-btn').forEach(button => {
				button.addEventListener('click', function() {
					const form = this.closest('form');
					
					// Disable button during request
					this.disabled = true;
					this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accepting...';
					
					// Simple fetch without CSRF
					fetch(form.action, {
						method: 'POST',
						headers: {
							'Accept': 'application/json',
						},
						body: new FormData(form)
					})
					.then(response => response.json())
					.then(data => {
						if(data.status === 'success') {
							// Just remove the card if successful
							this.closest('.trip-card').remove();
							
							// Update badge count
							const badge = document.getElementById('newRequestsBadge');
							if(badge) badge.textContent = parseInt(badge.textContent) - 1;

							updateAcceptedRides();
						}
					})
					.catch(error => {
						console.error('Error:', error);
						this.disabled = false;
						this.innerHTML = '<i class="fas fa-check"></i> Accept';
					});
				});
			});
		}
		
		function attachStartHandlers() {
			document.querySelectorAll('.start-btn').forEach(btn => {
				btn.addEventListener('click', function(e) {
					e.preventDefault();
					const form = this.closest('form');
					console.log('Form action:', form.action);
					
					// Disable button during request
					this.disabled = true;
					const originalText = this.innerHTML;
					this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
		
					fetch(form.action, {
						method: 'POST',
						headers: {
							'Accept': 'application/json',
						},
						body: new FormData(form)
					})
					.then(response => {
						console.log('Response status:', response.status);
						if (!response.ok) throw new Error('Network response failed');
						return response.json();
					})
					.then(data => {
						console.log('Response data:', data);
						if (data.status === 'success') {
							// Success - update both ride lists
							updateAcceptedRides();
							updateActiveRides();
						} else {
							throw new Error(data.message || 'Failed to start trip');
						}
					})
					.catch(error => {
						console.error('Error:', error);
						alert('Failed to start trip: ' + error.message);
					})
					.finally(() => {
						this.disabled = false;
						this.innerHTML = originalText;
					});
				});
			});
		}

		// Add this INSIDE your DOMContentLoaded event listener
// Replace your attachCompleteHandlers() calls with this

// Event delegation for complete buttons - works with dynamic content
document.addEventListener('click', function(e) {
    // Check if clicked element is a complete button or inside one
    const completeBtn = e.target.closest('.complete-btn');
    if (completeBtn) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('Complete button clicked!');
        
        const form = completeBtn.closest('form');
        if (!form) {
            console.error('No form found for complete button');
            return;
        }
        
        // Check if already processing
        if (completeBtn.disabled) {
            console.log('Button already disabled, ignoring click');
            return;
        }
        
        // Debug: Log form details
        console.log('=== COMPLETE TRIP DEBUG ===');
        console.log('Form action:', form.action);
        
        const formData = new FormData(form);
        console.log('Form data:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        
        // Get CSRF token
        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
        
        console.log('CSRF Token found:', csrfToken ? 'Yes' : 'No');
        
        // Disable button during request
        completeBtn.disabled = true;
        const originalText = completeBtn.innerHTML;
        completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Completing...';

        // Prepare headers
        const headers = {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        };
        
        // Add CSRF token if found
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        console.log('Sending POST request to:', form.action);

        fetch(form.action, {
            method: 'POST',
            headers: headers,
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Success response data:', data);
            if (data.status === 'success') {
                // Update the UI
                updateActiveRides();
                updateCompletedRides();
                
                // Switch to completed tab
                setTimeout(() => {
                    const completedTab = document.querySelector('[data-tab="completed-trips"]');
                    if (completedTab && !completedTab.classList.contains('active')) {
                        console.log('Switching to completed tab');
                        completedTab.click();
                    }
                }, 500);
                
                console.log('Trip completed successfully, UI updated');
            } else {
                throw new Error(data.message || data.error || 'Failed to complete trip');
            }
        })
        .catch(error => {
            console.error('Error completing trip:', error);
            alert(`Failed to complete trip: ${error.message}`);
        })
        .finally(() => {
            completeBtn.disabled = false;
            completeBtn.innerHTML = originalText;
            console.log('=== COMPLETE TRIP DEBUG END ===');
        });
    }
});

// Remove all attachCompleteHandlers() calls from your code since event delegation handles it
	
		// Initial setup
		updatePendingRides();
		updateAcceptedRides();
		updateActiveRides();
		updateCompletedRides();
		
	});

	// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - initializing pagination');
    
    // Event delegation for pagination buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('page-link') && e.target.dataset.page) {
            e.preventDefault();
            
            const page = e.target.dataset.page;
            const action = e.target.dataset.action;
            
            console.log('Pagination clicked:', action, 'page', page);
            
            switch(action) {
                case 'pending':
                    loadPendingRides(page);
                    break;
                case 'accepted':
                    loadAcceptedRides(page);
                    break;
                case 'active':
                    loadActiveRides(page);
                    break;
                case 'completed':
                    loadCompletedRides(page);
                    break;
            }
        }
    });
});

// Pending rides loader
function loadPendingRides(page) {
    console.log('Loading pending rides page:', page);
    
    const container = document.getElementById('pendingRidesContainer');
    if (!container) {
        console.error('Container not found: pendingRidesContainer');
        return;
    }
    
    // Show loading
    container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-spinner fa-spin"></i> Loading pending rides...
        </div>
    `;
    
    // Use the correct URL from your urls.py
    const url = `/driver/pending-rides/?page=${page}`;
    
    console.log('Fetching from:', url);
    
    fetch(url)
    .then(response => {
        console.log('Response status:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Data received successfully');
        container.innerHTML = data.html;
    })
    .catch(error => {
        console.error('Error loading pending rides:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #dc2626;">
                <i class="fas fa-exclamation-triangle"></i> Failed to load rides
                <br><small>Error: ${error.message}</small>
                <br><small>Tried URL: ${url}</small>
                <br><button onclick="loadPendingRides(1)" style="margin-top: 10px; padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
            </div>
        `;
    });
}

// Also update the other loader functions with correct URLs
function loadAcceptedRides(page) {
    const container = document.getElementById('acceptedRidesContainer');
    if (!container) return;
    
    container.innerHTML = `<div style="text-align:center;padding:40px;">Loading accepted rides...</div>`;
    
    fetch(`/driver/accepted-rides/?page=${page}`)
        .then(response => response.json())
        .then(data => container.innerHTML = data.html)
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = `<div style="text-align:center;padding:40px;color:red;">Error loading accepted rides</div>`;
        });
}

function loadActiveRides(page) {
    const container = document.getElementById('activeRidesContainer');
    if (!container) return;
    
    container.innerHTML = `<div style="text-align:center;padding:40px;">Loading active rides...</div>`;
    
    fetch(`/driver/active-rides/?page=${page}`)
        .then(response => response.json())
        .then(data => container.innerHTML = data.html)
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = `<div style="text-align:center;padding:40px;color:red;">Error loading active rides</div>`;
        });
}

function loadCompletedRides(page) {
    const container = document.getElementById('completedRidesContainer');
    if (!container) return;
    
    container.innerHTML = `<div style="text-align:center;padding:40px;">Loading completed rides...</div>`;
    
    fetch(`/driver/completed-trips/?page=${page}`)
        .then(response => response.json())
        .then(data => container.innerHTML = data.html)
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = `<div style="text-align:center;padding:40px;color:red;">Error loading completed rides</div>`;
        });
}

// Make functions globally available
window.loadPendingRides = loadPendingRides;
window.loadAcceptedRides = loadAcceptedRides;
window.loadActiveRides = loadActiveRides;
window.loadCompletedRides = loadCompletedRides;

console.log('Pagination functions loaded with correct URLs');

// Function to update driver location
function updateDriverLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                
                fetch('/api/update-driver-location/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        latitude: latitude,
                        longitude: longitude
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Location updated successfully');
                    // Refresh pending rides to show nearby ones
                    updatePendingRides();
                })
                .catch(error => {
                    console.error('Error updating location:', error);
                });
            },
            function(error) {
                console.error('Geolocation error:', error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000 // Update every minute
            }
        );
    }
}

// Update location on page load and every 30 seconds
document.addEventListener('DOMContentLoaded', function() {
    updateDriverLocation();
    setInterval(updateDriverLocation, 30000);
});

// Helper function to get CSRF token
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

 </script>
</body>
</html>