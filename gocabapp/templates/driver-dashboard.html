{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Dashboard - Modern Admin Panel</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Favicons -->
  <link href="" rel="icon">
  <link href="" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
	/* Global Variables and Base Styles */
	:root {
	  --primary-color: #08915e;
	  --primary-light: #e6f7f0;
	  --sidebar-width: 280px;
	  --transition: all 0.3s ease;
	}
	
	* {
	  margin: 0;
	  padding: 0;
	  box-sizing: border-box;
	}
	
	body {
	  font-family: 'Inter', sans-serif;
	  background-color: #f8fafc;
	  color: #333;
	  display: flex;
	  min-height: 100vh;
	}
  
	/* Sidebar Styles */
	#sidebar {
	  width: var(--sidebar-width);
	  background: white;
	  height: 100vh;
	  position: fixed;
	  top: 0;
	  left: 0;
	  box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
	  transition: var(--transition);
	  z-index: 1000;
	  padding: 1.5rem;
	  overflow-y: auto;
	}
	
	.sidebar-header {
	  display: flex;
	  align-items: center;
	  margin-bottom: 2.5rem;
	  padding-bottom: 1.5rem;
	  border-bottom: 1px solid #eee;
	}
	
	.sidebar-logo {
	  font-size: 1.5rem;
	  font-weight: 700;
	  color: var(--primary-color);
	  text-decoration: none;
	  display: flex;
	  align-items: center;
	}
	
	.sidebar-logo i {
	  margin-right: 0.75rem;
	  font-size: 1.75rem;
	}
	
	.sidebar-menu {
	  list-style: none;
	}
	
	.menu-title {
	  font-size: 0.75rem;
	  text-transform: uppercase;
	  letter-spacing: 0.1em;
	  color: #64748b;
	  margin: 1.5rem 0 0.75rem;
	  font-weight: 600;
	}
	
	.menu-item {
	  margin-bottom: 0.5rem;
	  position: relative;
	}
	
	.menu-link {
	  display: flex;
	  align-items: center;
	  padding: 0.75rem 1rem;
	  border-radius: 0.5rem;
	  color: #64748b;
	  text-decoration: none;
	  font-weight: 500;
	  transition: var(--transition);
	}
	
	.menu-link:hover {
	  background-color: var(--primary-light);
	  color: var(--primary-color);
	}
	
	.menu-link.active {
	  background-color: var(--primary-light);
	  color: var(--primary-color);
	  font-weight: 600;
	}
	
	.menu-link i {
	  margin-right: 0.75rem;
	  font-size: 1.1rem;
	  width: 24px;
	  text-align: center;
	}
	
	.menu-badge {
	  margin-left: auto;
	  background-color: var(--primary-color);
	  color: white;
	  font-size: 0.7rem;
	  padding: 0.2rem 0.5rem;
	  border-radius: 10px;
	  animation: bounce 1s infinite alternate;
	}
  
	/* Main Content Area */
	main {
	  margin-left: var(--sidebar-width);
	  flex-grow: 1;
	  padding: 2rem;
	  transition: var(--transition);
	}
	
	.page-header {
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  margin-bottom: 2rem;
	}
	
	.page-title {
	  font-size: 1.75rem;
	  font-weight: 600;
	  color: #1e293b;
	}
  
	/* Dashboard Layout */
	.trips-dashboard {
	  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
	  color: #333;
	  padding: 20px;
	  max-width: 1200px;
	  margin: 0 auto;
	}
	
	/* Tab Navigation */
	.trip-tabs {
	  display: flex;
	  border-bottom: 1px solid #e0e0e0;
	  margin-bottom: 20px;
	  overflow-x: auto;
	  scrollbar-width: none;
	}
	
	.trip-tabs::-webkit-scrollbar {
	  display: none;
	}
	
	.tab-btn {
	  padding: 12px 20px;
	  border: none;
	  background: none;
	  font-weight: 500;
	  font-size: 16px;
	  color: #666;
	  cursor: pointer;
	  position: relative;
	  display: flex;
	  align-items: center;
	  gap: 8px;
	  white-space: nowrap;
	}
	
	.tab-btn.active {
	  color: var(--primary-color);
	  font-weight: 600;
	  background-color: var(--primary-light);
	}
	
	.tab-btn.active::after {
	  content: '';
	  position: absolute;
	  bottom: -1px;
	  left: 0;
	  right: 0;
	  height: 3px;
	  background: var(--primary-color);
	}
	
	.badge {
	  background: var(--primary-color);
	  color: white;
	  border-radius: 10px;
	  padding: 2px 8px;
	  font-size: 12px;
	  font-weight: 500;
	}
  
	/* Ride Containers Grid */
	#pendingRidesContainer,
	#acceptedRidesContainer,
	#activeRidesContainer {
	  display: grid;
	  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
	  gap: 1.25rem;
	  margin-top: 1rem;
	}
  
	/* Section Management */
	.trip-section {
	  display: none;
	}
	
	.trip-section.active {
	  display: block;
	}
  
	/* Connection Status */
	.connection-status {
	  position: fixed;
	  bottom: 1.5rem;
	  right: 1.5rem;
	  background: white;
	  padding: 0.5rem 1rem;
	  border-radius: 50px;
	  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
	  display: flex;
	  align-items: center;
	  gap: 0.5rem;
	  font-size: 0.85rem;
	  z-index: 100;
	}
	
	.status-dot {
	  width: 10px;
	  height: 10px;
	  border-radius: 50%;
	  background: #ccc;
	  animation: pulse 1.5s infinite;
	}
	
	.status-dot.connected {
	  background: var(--primary-color);
	  animation: none;
	}
  
	/* Animations */
	@keyframes pulse {
	  0% { opacity: 1; }
	  50% { opacity: 0.3; }
	  100% { opacity: 1; }
	}
  
	@keyframes bounce {
	  from { transform: translateY(0); }
	  to { transform: translateY(-3px); }
	}
  
	/* Responsive Adjustments */
	@media (max-width: 768px) {
	  main {
		padding: 1rem;
	  }
	  
	  .trips-dashboard {
		padding: 0;
	  }
	  
	  #pendingRidesContainer,
	  #acceptedRidesContainer,
	  #activeRidesContainer {
		grid-template-columns: 1fr;
	  }
	}
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-header">
      <a href="#" class="sidebar-logo">
        <i class="fas fa-car"></i>  
        <span>GoCab</span>
      </a>
    </div>

    <ul class="sidebar-menu">
      <li class="menu-title">MAIN</li>
      
      <li class="menu-item">
        <a href="{% url 'driver_dashboard' %}" class="menu-link">
          <i class="fas fa-home"></i>
          <span>Overview</span>
        </a>
      </li>
	  <li class="menu-item">
        <a href="{% url 'driver_profile' %}" class="menu-link">
		<i class="fas fa-user"></i>
          <span>Profile</span>
        </a>
      </li>
	  <li class="menu-item">
        <a href="{% url 'driver_earnings' %}" class="menu-link">
		<i class="fas fa-wallet"></i>
          <span>Earnings</span>
        </a>
      </li>
      
      
	  <li class="menu-item">
        <a href="#" class="menu-link active">
            <i class="fas fa-bell"></i>  
          <span>Notification</span>
          <span class="menu-badge">12</span>
        </a>
      </li>

      <li class="menu-title">SETTINGS</li>
      
      
      
      <li class="menu-item">
        <a href="{% url 'logout' %}" class="menu-link">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </li>
      
     

      
    </ul>
  </div>

  <!-- Main Content -->
  <main>
    <div class="page-header">
      
    </div>

	<div class="trips-dashboard">
		<!-- Trip Status Tabs -->
		<div class="trip-tabs">
			<button class="tab-btn active" data-tab="new-trips">New Requests <span id="newRequestsBadge" class="badge">{{ new_requests }}</span></button>
			<button class="tab-btn" data-tab="starting-trips">Starting Trip <span id="acceptedRidesBadge" class="badge">{{ accepted_rides|length }}</span></button>
			<button class="tab-btn" data-tab="active-trips">Active Trips <span id="activeTripsBadge" class="badge">{{ active_trips }}</span></button>
			<button class="tab-btn" data-tab="completed-trips">Completed <span class="badge">{{ completed_trips}}</span></button>
		</div>
	  
		<!-- New Trips Section -->
		<div class="trip-section active" id="new-trips">
			<div id="pendingRidesContainer">
				{% include 'partials/_pending_rides.html' %}
			</div>
		</div>
	
		<!-- Starting Trip Section -->
		<div class="trip-section" id="starting-trips">
			<div id="acceptedRidesContainer">
				{% include 'partials/_accepted_rides.html' %}
			</div>
		</div>
	
		<!-- Active Trips Section -->
		<div class="trip-section" id="active-trips">
			<div id="activeRidesContainer">
				{% include 'partials/_active_rides.html' %}
			</div>
		</div>

		<!-- Active Trips Section -->
		<div class="trip-section" id="completed-trips">
			<div id="completedRidesContainer">
				{% include 'partials/_completed_rides.html' %}
			</div>
		</div>

	</div>
	
	<!-- WebSocket Status Indicator -->
	<div id="connectionStatus" class="connection-status">
		<span class="status-dot"></span>
		<span class="status-text">Connecting...</span>
	</div>
	  
	  
		
      
   
  </main>

 <script>
	document.addEventListener('DOMContentLoaded', function() {
		// Initialize WebSocket connection
		const driverSocket = new WebSocket(
			`ws://${window.location.host}/ws/driver/updates/`
		);
	
		// Connection status UI
		const connectionStatus = document.getElementById('connectionStatus');
		const statusDot = connectionStatus.querySelector('.status-dot');
		const statusText = connectionStatus.querySelector('.status-text');
	
		// WebSocket event handlers
		driverSocket.onopen = function() {
			statusDot.classList.add('connected');
			statusText.textContent = 'Connected';
			console.log('WebSocket connection established');
		};
	
		driverSocket.onerror = function(error) {
			statusDot.classList.remove('connected');
			statusText.textContent = 'Connection error';
			console.error('WebSocket error:', error);
		};
	
		driverSocket.onclose = function() {
			statusDot.classList.remove('connected');
			statusText.textContent = 'Disconnected - Reconnecting...';
			setTimeout(() => window.location.reload(), 5000);
		};
	
		driverSocket.onmessage = function(event) {
			const data = JSON.parse(event.data);
			console.log('WebSocket message received:', data);
			
			// Handle different event types - use consistent property name
			const eventType = data.event || data.type;
			
			switch(eventType) {
				case 'new_ride_request':
					console.log('New ride request received');
					updatePendingRides();
					break;
					
				case 'ride_accepted':
					console.log('Ride accepted event received');
					if (data.ride && data.ride.driver_id !== {{ request.user.id }}) {
						updatePendingRides();
					}
					break;
		
				case 'ride_update':
					console.log('Ride update event received:', data);
					// Handle ride status updates
					if (data.status) {
						switch(data.status) {
							case 'accepted':
								console.log('Ride status: accepted');
								updatePendingRides();
								updateAcceptedRides();
								break;
							case 'started':
								console.log('Ride status: started');
								updateAcceptedRides();
								updateActiveRides();
								break;
							case 'completed':
								console.log('Ride status: completed');
								updateActiveRides();
								updateCompletedRides();
								if (data.driver && data.driver.id === {{ request.user.id }}) {
									const completedTab = document.querySelector('[data-tab="completed-trips"]');
									if (!completedTab.classList.contains('active')) {
										completedTab.click();
									}
								}
								break;
							default:
								console.log('Unknown ride status:', data.status);
						}
					}
					break;
					
				case 'heartbeat_ack':
					// Silent heartbeat acknowledgment
					break;
					
				default:
					console.log('Unknown WebSocket event type:', eventType);
			}
		};

		
    setInterval(() => {
        if (driverSocket.readyState === WebSocket.OPEN) {
            driverSocket.send(JSON.stringify({type: 'heartbeat'}));
        }
    }, 30000);
	
		// Tab switching functionality
		document.querySelectorAll('.tab-btn').forEach(btn => {
			btn.addEventListener('click', function() {
				const tabId = this.getAttribute('data-tab');
				
				// Update active tab
				document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
				this.classList.add('active');
				
				// Show corresponding section
				document.querySelectorAll('.trip-section').forEach(section => {
					section.classList.remove('active');
				});
				document.getElementById(tabId).classList.add('active');
			});
		});
	
		function updatePendingRides() {
			fetch('/driver/pending-rides/', {
				headers: {
					'X-Requested-With': 'XMLHttpRequest'
				}
			})
			.then(response => {
				if (!response.ok) throw new Error('Network response was not ok');
				return response.json();
			})
			.then(data => {
				const container = document.getElementById('pendingRidesContainer');
				container.innerHTML = data.html;
				updateBadge('newRequestsBadge', container.querySelectorAll('.trip-card').length);
				attachAcceptHandlers();
			})
			.catch(error => {
				console.error('Error fetching pending rides:', error);
			});
		}
	
		// Function to update accepted rides
		function updateAcceptedRides() {
			fetch('/driver/accepted-rides/')
				.then(response => response.json())
				.then(data => {
					document.getElementById('acceptedRidesContainer').innerHTML = data.html;
					updateBadge('acceptedRidesBadge', document.querySelectorAll('#acceptedRidesContainer .trip-card').length);
					attachStartHandlers();
				})
				.catch(error => {
					console.error('Error fetching accepted rides:', error);
				});
		}
	
		function updateActiveRides() {
			fetch('/driver/active-rides/')
				.then(response => response.json())
				.then(data => {
					document.getElementById('activeRidesContainer').innerHTML = data.html;
					updateBadge('activeTripsBadge', document.querySelectorAll('#activeRidesContainer .trip-card').length);
				})
				.catch(error => {
					console.error('Error fetching active rides:', error);
				});
		}

		function updateCompletedRides() {
			fetch('/driver/completed-trips/')
				.then(response => response.json())
				.then(data => {
					const container = document.getElementById('completedRidesContainer');
            			container.innerHTML = data.html;
            
            			document.querySelector('#completed-trips .badge').textContent = 
                	container.querySelectorAll('.trip-card').length;
				})
				.catch(error => {
					console.error('Error fetching completed rides:', error);
				});
		}
	
		// Helper function to update badge counts
		function updateBadge(badgeId, count) {
			const badge = document.getElementById(badgeId);
			if (badge) {
				badge.textContent = count;
				if (count > 0) {
					badge.classList.add('has-items');
				} else {
					badge.classList.remove('has-items');
				}
			}
		}

		
	
		function attachAcceptHandlers() {
			document.querySelectorAll('.accept-btn').forEach(button => {
				button.addEventListener('click', function() {
					const form = this.closest('form');
					
					// Disable button during request
					this.disabled = true;
					this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accepting...';
					
					// Simple fetch without CSRF
					fetch(form.action, {
						method: 'POST',
						headers: {
							'Accept': 'application/json',
						},
						body: new FormData(form)
					})
					.then(response => response.json())
					.then(data => {
						if(data.status === 'success') {
							// Just remove the card if successful
							this.closest('.trip-card').remove();
							
							// Update badge count
							const badge = document.getElementById('newRequestsBadge');
							if(badge) badge.textContent = parseInt(badge.textContent) - 1;

							updateAcceptedRides();
						}
					})
					.catch(error => {
						console.error('Error:', error);
						this.disabled = false;
						this.innerHTML = '<i class="fas fa-check"></i> Accept';
					});
				});
			});
		}
		
		function attachStartHandlers() {
			document.querySelectorAll('.start-btn').forEach(btn => {
				btn.addEventListener('click', function(e) {
					e.preventDefault();
					const form = this.closest('form');
					console.log('Form action:', form.action);
					
					// Disable button during request
					this.disabled = true;
					const originalText = this.innerHTML;
					this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
		
					fetch(form.action, {
						method: 'POST',
						headers: {
							'Accept': 'application/json',
						},
						body: new FormData(form)
					})
					.then(response => {
						console.log('Response status:', response.status);
						if (!response.ok) throw new Error('Network response failed');
						return response.json();
					})
					.then(data => {
						console.log('Response data:', data);
						if (data.status === 'success') {
							// Success - update both ride lists
							updateAcceptedRides();
							updateActiveRides();
						} else {
							throw new Error(data.message || 'Failed to start trip');
						}
					})
					.catch(error => {
						console.error('Error:', error);
						alert('Failed to start trip: ' + error.message);
					})
					.finally(() => {
						this.disabled = false;
						this.innerHTML = originalText;
					});
				});
			});
		}

		// Add this to your existing JavaScript
function attachCompleteHandlers() {
    document.querySelectorAll('.complete-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const form = this.closest('form');
            
            // Disable button during request
            this.disabled = true;
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Completing...';

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Accept': 'application/json',
                },
                body: new FormData(form)
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response failed');
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Update all relevant sections
                    updateActiveRides();
                    updateCompletedRides();
                    
                    // Switch to completed tab
                    document.querySelector('[data-tab="completed-trips"]').click();
                } else {
                    throw new Error(data.message || 'Failed to complete trip');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to complete trip: ' + error.message);
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = originalText;
            });
        });
    });
}
	
		// Initial setup
		updatePendingRides();
		updateAcceptedRides();
		updateActiveRides();
		updateCompletedRides();
		attachCompleteHandlers();
	});
 </script>
</body>
</html>