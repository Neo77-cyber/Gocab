{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Dashboard - Modern Admin Panel</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Favicons -->
  <link href="" rel="icon">
  <link href="" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  

  <style>
    :root {
      --primary-color: #08915e;
      --primary-light: #e6f7f0;
      --sidebar-width: 280px;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
      color: #333;
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar Styles */
    #sidebar {
      width: var(--sidebar-width);
      background: white;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
      transition: var(--transition);
      z-index: 1000;
      padding: 1.5rem;
      overflow-y: auto;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
    }

    .sidebar-logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      text-decoration: none;
      display: flex;
      align-items: center;
    }

    .sidebar-logo i {
      margin-right: 0.75rem;
      font-size: 1.75rem;
    }

    .sidebar-menu {
      list-style: none;
    }

    .menu-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #64748b;
      margin: 1.5rem 0 0.75rem;
      font-weight: 600;
    }

    .menu-item {
      margin-bottom: 0.5rem;
      position: relative;
    }

    .menu-link {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      color: #64748b;
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
    }

    .menu-link:hover {
      background-color: var(--primary-light);
      color: var(--primary-color);
    }

    .menu-link.active {
      background-color: var(--primary-light);
      color: var(--primary-color);
      font-weight: 600;
    }

    .menu-link i {
      margin-right: 0.75rem;
      font-size: 1.1rem;
      width: 24px;
      text-align: center;
    }

    .menu-badge {
      margin-left: auto;
      background-color: var(--primary-color);
      color: white;
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
    }

    /* Checkbox style */
    .menu-checkbox {
      position: relative;
      padding-left: 2.5rem;
      cursor: pointer;
    }

    .menu-checkbox input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }

    .checkmark {
      position: absolute;
      top: 50%;
      left: 1rem;
      transform: translateY(-50%);
      height: 20px;
      width: 20px;
      background-color: white;
      border: 2px solid #ddd;
      border-radius: 4px;
      transition: var(--transition);
    }

    .menu-checkbox:hover .checkmark {
      border-color: var(--primary-color);
    }

    .menu-checkbox input:checked ~ .checkmark {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .checkmark:after {
      content: "";
      position: absolute;
      display: none;
      left: 6px;
      top: 2px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .menu-checkbox input:checked ~ .checkmark:after {
      display: block;
    }

    /* Main Content */
    main {
      margin-left: var(--sidebar-width);
      flex-grow: 1;
      padding: 2rem;
      transition: var(--transition);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 600;
      color: #1e293b;
    }

    .card {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    /* Responsive */
    @media (max-width: 992px) {
      #sidebar {
        transform: translateX(-100%);
      }
      
      #sidebar.active {
        transform: translateX(0);
      }
      
      main {
        margin-left: 0;
      }
    }
    .location-form {
        max-width: 400px;
        margin: 20px auto;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      }
    
      .location-input {
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
        background: white;
      }
    
      .form-group {
        margin-bottom: 20px;
      }
    
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
      }
    
      .location-field {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }
    
      .location-field:focus {
        outline: none;
        border-color: #08915e;
        box-shadow: 0 0 0 2px rgba(8, 145, 94, 0.1);
      }
    
      .location-field[readonly] {
        background-color: #f8f8f8;
        color: #666;
        cursor: not-allowed;
      }
    
      .submit-btn {
        width: 100%;
        padding: 14px;
        background-color: #08915e;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
    
      .submit-btn:hover {
        background-color: #067a4e;
      }
    
      .submit-btn i {
        font-size: 14px;
      }
    /* Base Styles */
  :root {
    --primary-color: #08915e;
    --text-color: #333;
    --light-gray: #f5f5f5;
    --border-color: #e0e0e0;
  }
  
  .card {
    width: 100%;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    overflow: hidden;
    margin: 20px 0;
  }
  
  .ride-history-section {
    width: 100%;
    padding: 20px;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }
  
  .section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 20px;
  }
  
  /* Filter Buttons */
  .history-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    overflow-x: auto;
    padding-bottom: 5px;
  }
  
  .filter-btn {
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    background: white;
    color: var(--text-color);
    font-size: 0.9rem;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s ease;
  }
  
  .filter-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }
  
  .filter-btn:hover {
    background: var(--light-gray);
  }
  
  /* Ride Cards */
  .ride-cards {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .ride-card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    border: 1px solid var(--border-color);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .ride-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .ride-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
  }
  
  .ride-date {
    font-size: 0.9rem;
    color: #666;
  }
  
  .ride-price {
    font-weight: 600;
    color: var(--primary-color);
  }
  
  /* Route Visualization */
  .ride-route {
    position: relative;
    padding: 0 10px 15px 25px;
    margin-bottom: 15px;
  }
  
  .location-pin {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
  }
  
  .location-pin i {
    font-size: 0.8rem;
  }
  
  .location-pin.start i {
    color: var(--primary-color);
  }
  
  .location-pin.end i {
    color: #ff4757;
  }
  
  .location-text {
    font-size: 0.95rem;
  }
  
  .route-line {
    position: absolute;
    left: 30px;
    top: 15px;
    bottom: 15px;
    width: 2px;
    background: linear-gradient(to bottom, var(--primary-color), #ff4757);
  }
  
  /* Driver Info */
  .ride-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
  }
  
  .driver-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .driver-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
  }
  
  .driver-name {
    font-weight: 500;
    font-size: 0.95rem;
  }
  
  .car-info {
    font-size: 0.8rem;
    color: #666;
  }
  
  /* Buttons */
  .action-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: white;
    color: var(--text-color);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .action-btn:hover {
    background: var(--light-gray);
  }
  
  .view-all-btn {
    display: block;
    width: 100%;
    padding: 12px;
    margin-top: 20px;
    background: white;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .view-all-btn:hover {
    background: var(--primary-color);
    color: white;
  }
  /* Card Container */
  .card {
    width: 100%;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    margin: 20px 0;
  }

  /* Profile Section - Now Full Width */
  .profile-section {
    width: 100%;
    padding: 24px;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }

  /* Profile Header */
  .profile-header {
    display: flex;
    align-items: center;
    margin-bottom: 24px;
    position: relative;
    padding-right: 40px; /* Space for edit button */
  }

  .profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #08915e, #06d6a0);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: bold;
    margin-right: 16px;
    flex-shrink: 0;
  }

  .profile-info {
    flex: 1;
    min-width: 0; /* Allows text truncation */
  }

  .profile-name {
    font-size: 24px;
    font-weight: 600;
    margin: 0 0 4px 0;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .profile-rating {
    display: flex;
    align-items: center;
    color: #666;
    font-size: 14px;
    flex-wrap: wrap;
  }

  .profile-rating i {
    color: #FFC107;
    margin-right: 4px;
    font-size: 16px;
  }

  .profile-rating span {
    margin-right: 8px;
  }

  .rating-count {
    color: #999;
  }

  .edit-profile-btn {
    position: absolute;
    top: 0;
    right: 0;
    background: #f5f5f5;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .edit-profile-btn:hover {
    background: #e0e0e0;
  }

  /* Profile Stats - Now responsive columns */
  .profile-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
    padding: 16px 0;
    border-top: 1px solid #eee;
    border-bottom: 1px solid #eee;
  }

  .stat-item {
    text-align: center;
  }

  .stat-value {
    font-size: 24px;
    font-weight: 600;
    color: #08915e;
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 14px;
    color: #666;
  }

  /* Ride Tracking Card */
.ride-tracking-card {
  border-radius: 20px;
  padding: 24px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  border: 2px solid #dcfce7;
  margin: 20px 0;
  position: relative;
  overflow: hidden;
}

.ride-tracking-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  
}

/* Tracking Header */
.tracking-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 24px;
}

.tracking-status {
  display: flex;
  align-items: center;
  gap: 16px;
}

.status-indicator {
  position: relative;
  width: 50px;
  height: 50px;
}

.pulse-dot {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-radius: 50%;
  animation: pulse 2s ease-in-out infinite;
}

.status-indicator i {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 20px;
  z-index: 2;
}

@keyframes pulse {
  0% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
  }
  70% {
      box-shadow: 0 0 0 12px rgba(34, 197, 94, 0);
  }
  100% {
      transform: scale(1.05);
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
  }
}

.status-text h3 {
  color: #166534;
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0 0 4px 0;
}

.status-subtitle {
  color: #65a30d;
  font-size: 0.9rem;
  margin: 0;
}

.tracking-timer {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #dcfce7;
  padding: 8px 16px;
  border-radius: 20px;
  color: #166534;
  font-weight: 600;
  border: 1px solid #bbf7d0;
}

.tracking-timer i {
  color: #16a34a;
}

/* Searching State */
.searching-state {
  text-align: center;
  padding: 20px 0;
}

.searching-animation {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto 20px;
}

.search-pulse {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80px;
  height: 80px;
  background: rgba(34, 197, 94, 0.1);
  border-radius: 50%;
  animation: searchPulse 2s ease-out infinite;
}

@keyframes searchPulse {
  0% {
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0.7;
  }
  50% {
      transform: translate(-50%, -50%) scale(1.2);
      opacity: 0.3;
  }
  100% {
      transform: translate(-50%, -50%) scale(1.5);
      opacity: 0;
  }
}

.floating-cars {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.floating-cars i {
  position: absolute;
  color: #16a34a;
  font-size: 20px;
  opacity: 0;
  animation: floatCars 3s ease-in-out infinite;
}

.car-1 {
  top: 20%;
  left: 30%;
  animation-delay: 0s;
}

.car-2 {
  top: 60%;
  left: 60%;
  animation-delay: 1s;
}

.car-3 {
  top: 40%;
  left: 20%;
  animation-delay: 2s;
}

@keyframes floatCars {
  0%, 100% {
      opacity: 0;
      transform: translateY(20px) scale(0.8);
  }
  50% {
      opacity: 1;
      transform: translateY(0) scale(1);
  }
}

.searching-text {
  margin-top: 16px;
}

.searching-message {
  color: #166534;
  font-size: 1rem;
  margin: 0 0 12px 0;
  font-weight: 500;
}

.loading-dots {
  display: flex;
  justify-content: center;
  gap: 4px;
}

.loading-dots span {
  width: 8px;
  height: 8px;
  background: #22c55e;
  border-radius: 50%;
  animation: bounce 1.4s ease-in-out infinite both;
}

.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.loading-dots span:nth-child(2) { animation-delay: -0.16s; }
.loading-dots span:nth-child(3) { animation-delay: 0s; }

@keyframes bounce {
  0%, 80%, 100% {
      transform: scale(0.8);
      opacity: 0.5;
  }
  40% {
      transform: scale(1.2);
      opacity: 1;
  }
}

/* Cancel Button */
.tracking-actions {
  margin-top: 24px;
  text-align: center;
}

.cancel-ride-btn {
  background: linear-gradient(135deg, #ffffff, #fef2f2);
  color: #dc2626;
  border: 2px solid #fecaca;
  padding: 12px 24px;
  border-radius: 25px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
}

.cancel-ride-btn:hover {
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(220, 38, 38, 0.15);
  border-color: #fca5a5;
}

/* Responsive Design */
@media (max-width: 768px) {
  .ride-tracking-card {
      padding: 20px;
      margin: 16px 0;
      border-radius: 16px;
  }
  
  .tracking-header {
      flex-direction: column;
      gap: 16px;
      align-items: center;
      text-align: center;
  }
  
  .tracking-status {
      flex-direction: column;
      gap: 12px;
  }
  
  .status-text h3 {
      font-size: 1.1rem;
  }
  
  .searching-animation {
      width: 100px;
      height: 100px;
  }
  
  .cancel-ride-btn {
      padding: 10px 20px;
      font-size: 0.85rem;
  }
}

  /* Profile Details */
  .profile-details {
    margin-bottom: 24px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .detail-item {
    display: flex;
    align-items: center;
    font-size: 15px;
    min-width: 0; /* Allows text truncation */
  }

  .detail-item i {
    width: 24px;
    color: #08915e;
    margin-right: 12px;
    text-align: center;
    flex-shrink: 0;
  }

  .detail-item span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Profile Actions - Responsive buttons */
  .profile-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }

  .action-btn {
    padding: 12px;
    border-radius: 8px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .action-btn.primary {
    background: #08915e;
    color: white;
  }

  .action-btn.primary:hover {
    background: #067a4e;
  }

  .action-btn.secondary {
    background: #f5f5f5;
    color: #333;
  }

  .action-btn.secondary:hover {
    background: #e0e0e0;
  }

  /* Responsive Adjustments */
  @media (max-width: 600px) {
    .profile-header {
      flex-direction: column;
      text-align: center;
      padding-right: 0;
    }
    
    .profile-avatar {
      margin-right: 0;
      margin-bottom: 16px;
    }
    
    .edit-profile-btn {
      position: relative;
      margin-top: 16px;
    }
    
    .profile-details {
      grid-template-columns: 1fr;
    }
  }
  /* Fare Estimate Container */
  .fare-estimate {
    background-color: #f8fafc;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Fare Breakdown */
  .fare-breakdown {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .fare-breakdown h4 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  #fareAmount {
    color: #08915e;
    font-weight: 700;
    font-size: 1.4rem;
  }

  .fare-breakdown p {
    margin: 0;
    font-size: 0.95rem;
    color: #64748b;
    display: flex;
    justify-content: space-between;
  }

  .fare-breakdown p small {
    display: flex;
    gap: 15px;
  }

  /* Distance and Time Spans */
  #distanceText, 
  #durationText {
    color: #334155;
    font-weight: 500;
  }

  /* Surge Pricing Notice */
  #surgeNotice {
    background-color: #fff4e6;
    padding: 10px 15px;
    border-radius: 8px;
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.4); }
    70% { box-shadow: 0 0 0 6px rgba(255, 165, 0, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0); }
  }

  #surgeNotice i {
    color: #ff9500;
  }

  #surgeMultiplier {
    font-weight: 700;
    color: #e67e22;
  }

  /* Responsive Adjustments */
  @media (max-width: 480px) {
    .fare-breakdown h4 {
      font-size: 1.1rem;
      flex-direction: column;
      align-items: flex-start;
      gap: 5px;
    }
    
    .fare-breakdown p small {
      flex-direction: column;
      gap: 5px;
    }
  }
/* Ride Tracking Card Container */
#rideTrackingCard {
  background-color: #ffffff;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  padding: 24px;
  max-width: 400px;
  margin: 20px auto;
  transition: all 0.3s ease;
  border: 1px solid #e1e1e1;
}

/* Shared State Styles */
#searchingState, 
#driverAssignedState {
  text-align: center;
  padding: 20px 0;
  transition: opacity 0.5s ease;
}

/* Searching State */
#searchingState {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}
/* Trip Completed State */
.trip-completed-state {
  text-align: center;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 10px;
  margin: 15px 0;
}

.completion-icon {
  font-size: 3rem;
  color: #28a745;
  margin-bottom: 15px;
}

.completion-details h3 {
  color: #28a745;
  margin-bottom: 15px;
}

.fare-amount {
  background: white;
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  border: 2px solid #e9ecef;
}

.fare-label {
  font-weight: 600;
  color: #6c757d;
}

.fare-value {
  font-size: 1.5rem;
  font-weight: bold;
  color: #28a745;
  display: block;
  margin-top: 5px;
}

.driver-info-completed {
  text-align: left;
  background: white;
  padding: 15px;
  border-radius: 8px;
  border: 1px solid #e9ecef;
}

.driver-info-completed p {
  margin: 8px 0;
  color: #495057;
}

/* Pay Now Button */
.pay-now-btn {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  border: none;
  padding: 15px 25px;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.pay-now-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
}

.payment-processing-btn {
  background: #6c757d;
  color: white;
  border: none;
  padding: 15px 25px;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: not-allowed;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.payment-completed-state {
  background: #d4edda;
  color: #155724;
  padding: 15px 25px;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  border: 1px solid #c3e6cb;
}

.pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 20px;
  padding: 15px 0;
  border-top: 1px solid #eee;
}

.page-numbers {
  display: flex;
  gap: 8px;
}

.page-link {
  padding: 8px 16px;
  border: 1px solid #ddd;
  background: white;
  color: #333;
  text-decoration: none;
  border-radius: 6px;
  transition: all 0.3s ease;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.page-link:hover {
  background: #08915E;
  color: white;
  border-color: #08915E;
}

.page-link.current {
  background: #08915E;
  color: white;
  border-color:#08915E;
}

.pagination-info {
  text-align: center;
  color: #666;
  font-size: 14px;
  margin-top: 10px;
}

/* Remove the old View All button since we have pagination */
.view-all-btn {
  display: none;
}

/* Hide cancel button when trip is completed */
.trip-completed-state ~ .tracking-actions .cancel-ride-btn {
  display: none;
}

#searchingState i.fas {
  font-size: 3rem;
  color: #4a6bff;
  animation: pulse 2s infinite;
}

#searchingState p {
  font-size: 1.2rem;
  color: #333;
  font-weight: 500;
  margin: 0;
}

/* Driver Assigned State */
#driverAssignedState {
  display: none; /* Will be shown via JS */
}

#driverInfo {
  background-color: #f8f9ff;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
}

#driverInfo p {
  margin: 8px 0;
  font-size: 1.1rem;
  color: #444;
}

#driverInfo span {
  font-weight: 600;
  color: #2d3748;
}

#estimatedArrival {
  font-size: 1.3rem;
  font-weight: 700;
  color: #4a6bff;
}

/* Cancel Button */
#cancelRideBtn {
  width: 100%;
  padding: 12px;
  background-color: #fff;
  color: #ff4a4a;
  border: 1px solid #ff4a4a;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-top: 20px;
}

#cancelRideBtn:hover {
  background-color: #ffebeb;
}

#cancelRideBtn:active {
  transform: scale(0.98);
}

/* Payment Completed State */
.payment-completed-state {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  border-radius: 20px;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  font-weight: 600;
  font-size: 14px;
  min-width: 100px;
  justify-content: center;
  border: none;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  animation: fadeIn 0.3s ease-in-out;
}

.payment-completed-state i {
  font-size: 16px;
  color: #ffffff;
}

/* Payment Status Paid */
.payment-status.paid {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  border-radius: 20px;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  font-weight: 600;
  font-size: 14px;
  border: none;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.payment-status.paid i {
  font-size: 16px;
  color: #ffffff;
}

.payment-status.paid span {
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* Optional hover effect */
.payment-status.paid:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  transition: all 0.2s ease;
}

/* Responsive design */
@media (max-width: 768px) {
  .payment-status.paid {
      padding: 6px 12px;
      font-size: 13px;
      gap: 6px;
  }
  
  .payment-status.paid i {
      font-size: 14px;
  }
}

@media (max-width: 480px) {
  .payment-status.paid {
      padding: 5px 10px;
      font-size: 12px;
      gap: 4px;
  }
  
  .payment-status.paid i {
      font-size: 12px;
  }
}

.payment-completed-state span {
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* Hover effect for subtle interaction */
.payment-completed-state:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  transition: all 0.2s ease;
}

/* Responsive design */
@media (max-width: 768px) {
  .payment-completed-state {
      padding: 8px 14px;
      font-size: 13px;
      min-width: 90px;
      gap: 6px;
  }
  
  .payment-completed-state i {
      font-size: 14px;
  }
}

@media (max-width: 480px) {
  .payment-completed-state {
      padding: 6px 12px;
      font-size: 12px;
      min-width: 80px;
      gap: 4px;
  }
  
  .payment-completed-state i {
      font-size: 12px;
  }
}

/* Animation for smooth appearance */
@keyframes fadeIn {
  from {
      opacity: 0;
      transform: translateY(5px) scale(0.95);
  }
  to {
      opacity: 1;
      transform: translateY(0) scale(1);
  }
}

/* Optional: Add a subtle pulse animation for attention */
@keyframes subtlePulse {
  0%, 100% {
      transform: scale(1);
  }
  50% {
      transform: scale(1.02);
  }
}

.payment-completed-state {
  animation: fadeIn 0.3s ease-in-out;
}

/* Add this if you want a subtle continuous pulse */
.payment-completed-state.pulse {
  animation: fadeIn 0.3s ease-in-out, subtlePulse 2s ease-in-out infinite;
}



/* Animation for Searching State */
@keyframes pulse {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.8;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

/* Responsive Adjustments */
@media (max-width: 480px) {
  #rideTrackingCard {
    padding: 18px;
    margin: 15px;
  }
  
  #searchingState i.fas {
    font-size: 2.5rem;
  }
  
  #searchingState p {
    font-size: 1.1rem;
  }
  
  #driverInfo p {
    font-size: 1rem;
  }
}
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-header">
      <a href="#" class="sidebar-logo">
        <i class="fas fa-car"></i>  
        <span>GoCab</span>
      </a>
    </div>

    <ul class="sidebar-menu">
      <li class="menu-title">MAIN</li>
      
      
      
      <li class="menu-item">
        <a href="#" class="menu-link active">
            <i class="fas fa-bell"></i>  
          <span>Notification</span>
          <span class="menu-badge" style="display: {% if notification_count > 0 %}inline-block{% else %}none{% endif %}">
            {{ notification_count }}
        </span>

        </a>
      </li>

      <li class="menu-title">SETTINGS</li>
      
      
      
      <li class="menu-item">
        <a href="{% url 'logout' %}" class="menu-link">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </li>
      
     

      
    </ul>
  </div>

  <!-- Main Content -->
  <main>
    <div class="page-header">
      
    </div>

    <div class="card">
      <form id="rideForm" class="location-form">
        {% csrf_token %}
        <div class="location-input">
          <div class="form-group">
            <label for="current-location">Current Location</label>
            <input 
              type="text" 
              id="current-location" 
              name="current_location" 
              placeholder="Enter your location" 
              class="location-field"
              required
            >
          </div>
          
          <div class="form-group">
            <label for="destination">Where to?</label>
            <input 
              type="text" 
              id="destination" 
              name="destination" 
              placeholder="Enter your destination" 
              class="location-field"
              required
            >
          </div>
          
          <!-- Fare Estimate Display -->
          <div id="fareEstimate" class="fare-estimate" style="display:none;">
            <div class="fare-breakdown">
              <h4>Estimated Fare: <span id="fareAmount">₦--.--</span></h4>
              <p><small>Distance: <span id="distanceText">-- km</span> • Time: <span id="durationText">-- mins</span></small></p>
              <p id="surgeNotice" style="color: orange; display:none;">
                <i class="fas fa-bolt"></i> Surge pricing in effect (x<span id="surgeMultiplier">1.5</span>)
              </p>
            </div>
          </div>
          
          <button type="submit" class="submit-btn">
            <i class="fas fa-paper-plane"></i> Book a Ride
          </button>
        </div>
      </form>
    </div>

    
    <div id="rideTrackingCard" class="ride-tracking-card" style="display:none;">
      <div class="tracking-header">
          <div class="tracking-status">
              <div class="status-indicator">
                  <div class="pulse-dot"></div>
                  <i class="fas fa-car-side"></i>
              </div>
              <div class="status-text">
                  <h3 id="trackingStatus">Finding you a driver</h3>
              </div>
          </div>
          <div class="tracking-timer">
              <i class="fas fa-clock"></i>
              <span id="searchTimer">00:00</span>
          </div>
      </div>
  
      <div id="searchingState" class="searching-state">
          <div class="searching-animation">
              <div class="search-pulse"></div>
              <div class="floating-cars">
                  <i class="fas fa-car car-1"></i>
                  <i class="fas fa-car car-2"></i>
                  <i class="fas fa-car car-3"></i>
              </div>
          </div>
          <div class="searching-text">
              <p class="searching-message">Searching for available drivers</p>
              <div class="loading-dots">
                  <span></span>
                  <span></span>
                  <span></span>
              </div>
          </div>
      </div>
  
      <div id="driverAssignedState" class="driver-assigned-state" style="display:none;">
          <div id="driverInfo">
              <p>Driver: <span id="driverName"></span></p>
              <p>Car: <span id="vehicleInfo"></span></p>
          </div>
          <p>ETA: <span id="estimatedArrival"></span></p>
      </div>
  
      <!-- TRIP COMPLETED STATE - Add this new section -->
      <div id="tripCompletedState" class="trip-completed-state" style="display:none;">
          <div class="completion-icon">
              <i class="fas fa-check-circle"></i>
          </div>
          <div class="completion-details">
              <h3>Trip Completed!</h3>
              <div class="fare-amount">
                  <span class="fare-label">Total Fare:</span>
                  <span class="fare-value">₦<span id="completedFareAmount">0.00</span></span>
              </div>
              <div class="driver-info-completed">
                  <p><strong>Driver:</strong> <span id="completedDriverName"></span></p>
                  <p><strong>Car:</strong> <span id="completedVehicleInfo"></span></p>
              </div>
          </div>
      </div>
  
      <div class="tracking-actions">
          <!-- Cancel Ride Button (shown during active ride) -->
          <button id="cancelRideBtn" class="cancel-ride-btn">
              <i class="fas fa-times"></i>
              Cancel Ride Request
          </button>
  
          <!-- Pay Now Button (shown after trip completion) -->
          <button id="payNowBtn" class="pay-now-btn" style="display:none;">
              <i class="fas fa-credit-card"></i>
              Pay Now - ₦<span id="payNowAmount">0.00</span>
          </button>
  
          <!-- Payment Processing (shown after clicking Pay Now) -->
          <button id="paymentProcessingBtn" class="payment-processing-btn" style="display:none;" disabled>
              <i class="fas fa-spinner fa-spin"></i>
              Processing Payment...
          </button>
  
          <!-- Payment Completed (shown after successful payment) -->
          <div id="paymentCompletedState" class="payment-completed-state" style="display:none;">
              <i class="fas fa-check-circle"></i>
              <span>Payment Completed!</span>
          </div>
      </div>
  </div>
      
      
      
      

  
    
    
   
  <div class="card">
    <div class="ride-history-section">
      <h2 class="section-title">Your Ride History</h2>
      
      <div class="history-filters">
          <button class="filter-btn active">All</button>
          <button class="filter-btn">This Week</button>
          <button class="filter-btn">This Month</button>
          <button class="filter-btn">Past Year</button>
      </div>
      
      <div class="ride-cards">
          {% for ride in recent_rides %}
          <!-- Ride Card -->
          <div class="ride-card">
              <div class="ride-header">
                  <div class="ride-date">{{ ride.completed_at|date:"l, g:i A" }}</div>
                  <div class="ride-price">₦{{ ride.total_fare|floatformat:2 }}</div>
              </div>
              
              <div class="ride-route">
                  <div class="location-pin start">
                      <i class="fas fa-circle"></i>
                      <div class="location-text">{{ ride.current_location|truncatechars:20 }}</div>
                  </div>
                  <div class="route-line"></div>
                  <div class="location-pin end">
                      <i class="fas fa-map-marker-alt"></i>
                      <div class="location-text">{{ ride.destination|truncatechars:20 }}</div>
                  </div>
              </div>
              
              <div class="ride-footer">
                  <div class="driver-info">
                      <div class="driver-avatar">
                          {{ ride.driver.get_full_name|default:ride.driver.username|slice:":2"|upper }}
                      </div>
                      <div class="driver-details">
                          <div class="driver-name">{{ ride.driver.get_full_name|default:ride.driver.username }}</div>
                          <div class="car-info">
                              {% if ride.driver.driver.vehicle_model %}
                                  {{ ride.driver.driver.vehicle_model }} • {{ ride.driver.driver.license_plate }}
                              {% else %}
                                  Vehicle info not available
                              {% endif %}
                          </div>
                      </div>
                  </div>
                  <button class="action-btn">Details</button>
              </div>
          </div>

          <!-- Payment Status Section -->
          <div class="payment-section">
            {% if ride.payment_status == 'paid' %}
            <div class="payment-status paid">
                <i class="fas fa-check-circle"></i>
                <span>Paid</span>
            </div>
            {% else %}
            <div class="payment-actions">
                <button class="pay-now-btn" data-ride-id="{{ ride.id }}" data-amount="{{ ride.total_fare }}">
                    <i class="fas fa-credit-card"></i>
                    Pay ₦{{ ride.total_fare|floatformat:2 }}
                </button>
                
                <button class="payment-processing-btn" style="display:none;" disabled>
                    <i class="fas fa-spinner fa-spin"></i>
                    Processing...
                </button>
                
                <div class="payment-completed-state" style="display:none;">
                    <i class="fas fa-check-circle"></i>
                    <span>Paid</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
          {% empty %}
          <div class="no-rides">No recent rides found</div>
          {% endfor %}
      </div>
      
      <!-- Pagination -->
      {% if recent_rides.has_other_pages %}
      <div class="pagination">
          {% if recent_rides.has_previous %}
              <a href="?page={{ recent_rides.previous_page_number }}" class="page-link">
                  <i class="fas fa-chevron-left"></i> Previous
              </a>
          {% endif %}
          
          <div class="page-numbers">
              {% for num in recent_rides.paginator.page_range %}
                  {% if recent_rides.number == num %}
                      <span class="page-link current">{{ num }}</span>
                  {% elif num > recent_rides.number|add:'-3' and num < recent_rides.number|add:'3' %}
                      <a href="?page={{ num }}" class="page-link">{{ num }}</a>
                  {% endif %}
              {% endfor %}
          </div>
          
          {% if recent_rides.has_next %}
              <a href="?page={{ recent_rides.next_page_number }}" class="page-link">
                  Next <i class="fas fa-chevron-right"></i>
              </a>
          {% endif %}
      </div>
      {% endif %}
      
      <!-- Show total count info -->
      <div class="pagination-info">
          Showing {{ recent_rides.start_index }}-{{ recent_rides.end_index }} of {{ recent_rides.paginator.count }} rides
      </div>
    </div>
  </div>

      
   
  </main>

  <script>
const GOOGLE_MAPS_API_KEY = 'AIzaSyAUMHV6_Zn7ThpeGbl8qC6gMmfvxKU7IgI';
let rideStatusInterval = null;
let currentRideId = null;
let rideSocket = null;

const CURRENT_RIDE_ID = "{{ request.session.current_ride_id|default:'' }}";
const CURRENT_RIDE_STATUS = "{{ request.session.current_ride_status|default:'' }}";
const COMPLETED_RIDE_FARE = {{ request.session.completed_ride_fare|default:0 }};
const CURRENT_DRIVER = {% if request.session.current_driver %}{{ request.session.current_driver|safe }}{% else %}null{% endif %};

console.log('[SESSION INIT]', {
  rideId: CURRENT_RIDE_ID,
  status: CURRENT_RIDE_STATUS,
  fare: COMPLETED_RIDE_FARE,
  driver: CURRENT_DRIVER
});


// Add this near your other WebSocket code
function connectNotificationWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const notificationSocket = new WebSocket(
      `${protocol}//${window.location.host}/ws/notifications/`
  );

  notificationSocket.onopen = () => {
      console.log("Connected to notifications");
  };

  notificationSocket.onerror = (error) => {
      console.error("Notification WebSocket error:", error);
  };

  notificationSocket.onclose = () => {
      console.log("Disconnected from notifications");
      setTimeout(connectNotificationWebSocket, 3000);
  };

  notificationSocket.onmessage = (e) => {
      const data = JSON.parse(e.data);
      if (data.type === 'counter') {
          updateNotificationCount(data.count);
      }
  };
}

function updateNotificationCount(count) {
  const badge = document.querySelector('.menu-badge');
  if (badge) {
      badge.textContent = count;
      if (count > 0) {
          badge.style.display = 'inline-block';
      } else {
          badge.style.display = 'none';
      }
  }
}

// Call this when the page loads
document.addEventListener('DOMContentLoaded', function() {
  connectNotificationWebSocket();
  // ... your other existing code
});

// Initialize WebSocket connection
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    rideSocket = new WebSocket(
        `${protocol}//${window.location.host}/ws/ride/updates/`
    );

    rideSocket.onopen = () => {
        console.log("Connected to ride updates");
        if (currentRideId) {
            subscribeToRide(currentRideId);
        }
    };

    rideSocket.onerror = (error) => {
        console.error("WebSocket error:", error);
    };

    rideSocket.onclose = () => {
        console.log("Disconnected from ride updates");
        setTimeout(connectWebSocket, 3000);
    };

    rideSocket.onmessage = (e) => {
        console.log("WebSocket update:", e.data);
        const data = JSON.parse(e.data);
        console.log("WebSocket update:", data);
        handleWebSocketUpdate(data);
    };
}

// Subscribe to ride updates
function subscribeToRide(rideId) {
    if (rideSocket && rideSocket.readyState === WebSocket.OPEN) {
        rideSocket.send(JSON.stringify({
            action: 'subscribe',
            ride_id: rideId
        }));
    }
}

function handleWebSocketUpdate(data) {
    if (data.type === 'ride_update') {
        const statusMap = {
            'accepted': 'accepted',
            'started': 'started',
            'completed': 'completed',
            'cancelled': 'cancelled'
        };
        
        updateRideStatusUI({
            status: statusMap[data.event],
            driver: data.data?.driver,
            eta: data.data?.eta,
            fare: data.data?.fare
        });

        if (data.event === 'cancelled') {
          hideRideTrackingCard();
      }
    }
}

function hideRideTrackingCard() {
  const rideTrackingCard = document.getElementById('rideTrackingCard');
  const rideForm = document.getElementById('rideForm');
  
  if (rideTrackingCard) {
      rideTrackingCard.style.display = 'none';
  }
  
  if (rideForm) {
      rideForm.style.display = 'block';
      resetRideForm(); // Show the form again
  }
}


function resetRideForm() {
  const currentLocation = document.getElementById('current-location');
  const destination = document.getElementById('destination');
  const fareEstimate = document.getElementById('fareEstimate');
  
  if (currentLocation) currentLocation.value = '';
  if (destination) destination.value = '';
  if (fareEstimate) fareEstimate.style.display = 'none';
}

function hideFareEstimate() {
    const fareEstimate = document.getElementById('fareEstimate');
    if (fareEstimate) {
        fareEstimate.style.display = 'none';
    }
}

function setLoadingState(button, isLoading) {
    if (!button) return;
    
    if (isLoading) {
        button.disabled = true;
        const spinner = document.createElement('i');
        spinner.className = 'fas fa-spinner fa-spin';
        button.innerHTML = '';
        button.appendChild(spinner);
        button.appendChild(document.createTextNode(' Calculating...'));
    } else {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-calculator"></i> Calculate Fare';
    }
}


window.initAutocomplete = function() {
    console.log("Google Maps callback initiated");
    
    const currentLocationField = document.getElementById('current-location');
    const destinationField = document.getElementById('destination');
    
    if (!currentLocationField || !destinationField) {
        console.error("Location input fields not found");
        return;
    }

    if (!window.google?.maps?.places) {
        console.error("Google Maps Places API not loaded");
        return;
    }

    try {
        const options = {
            types: ['geocode'],
            fields: ['formatted_address', 'geometry', 'place_id'],
            componentRestrictions: {country: 'ng'}
        };

        const currentLocationAutocomplete = new google.maps.places.Autocomplete(currentLocationField, options);
        const destinationAutocomplete = new google.maps.places.Autocomplete(destinationField, options);
        
        // Add event listeners for place selection
        currentLocationAutocomplete.addListener('place_changed', function() {
            const place = currentLocationAutocomplete.getPlace();
            console.log('Current location selected:', place.formatted_address);
        });

        destinationAutocomplete.addListener('place_changed', function() {
            const place = destinationAutocomplete.getPlace();
            console.log('Destination selected:', place.formatted_address);
        });
        
        console.log("Autocomplete initialized successfully");
    } catch (error) {
        console.error("Autocomplete initialization error:", error);
        showFallbackInputs();
    }
};

// Replace your restoreRideFromSession function with this improved version
function restoreRideFromSession() {
  console.log('[SESSION CHECK] Starting session restore');
  console.log('[SESSION DATA]', {
      rideId: CURRENT_RIDE_ID,
      status: CURRENT_RIDE_STATUS,
      fare: COMPLETED_RIDE_FARE,
      driver: CURRENT_DRIVER
  });

  if (!CURRENT_RIDE_ID || CURRENT_RIDE_ID === "") {
      console.log('[SESSION] No active ride found');
      showRideForm();
      return;
  }

  // We have an active ride - restore it
  console.log('[SESSION] Found active ride:', CURRENT_RIDE_ID, 'Status:', CURRENT_RIDE_STATUS);
  currentRideId = CURRENT_RIDE_ID;

  const rideForm = document.getElementById('rideForm');
  const trackingCard = document.getElementById('rideTrackingCard');
  
  // Hide form, show tracking
  if (rideForm) rideForm.style.display = 'none';
  if (trackingCard) trackingCard.style.display = 'block';
  
  // Build session data object
  const sessionData = {
      status: CURRENT_RIDE_STATUS,
      fare: COMPLETED_RIDE_FARE,
      payment_status: CURRENT_RIDE_STATUS === 'completed' ? 'pending' : null,
      driver: CURRENT_DRIVER
  };

  console.log('[SESSION] Restoring UI with data:', sessionData);
  
  // Update UI immediately with session data
  updateRideStatusUI(sessionData);
  
  // Connect WebSocket for real-time updates
  if (rideSocket && rideSocket.readyState === WebSocket.OPEN) {
      subscribeToRide(CURRENT_RIDE_ID);
  }
  
  // Start polling for status updates (except for completed rides)
  if (CURRENT_RIDE_STATUS !== 'completed') {
      console.log('[SESSION] Starting status polling for ride:', CURRENT_RIDE_ID);
      checkRideStatus(); // Check immediately
      clearInterval(rideStatusInterval);
      rideStatusInterval = setInterval(checkRideStatus, 3000);
  } else {
      console.log('[SESSION] Ride completed - showing payment state');
      // For completed rides, do one final status check to get payment status
      checkRideStatus();
  }
}

function showRideForm() {
  const rideForm = document.getElementById('rideForm');
  const trackingCard = document.getElementById('rideTrackingCard');
  if (rideForm) rideForm.style.display = 'block';
  if (trackingCard) trackingCard.style.display = 'none';
}

// Update your DOMContentLoaded to ensure proper initialization order
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM loaded, initializing application");
  
  // 1. Load Google Maps API first
  loadGoogleMapsAPI();
  
  // 2. Connect WebSocket
  connectWebSocket();
  
  // 3. Connect notification WebSocket
  connectNotificationWebSocket();
  
  // 4. Restore ride from session (this must come after WebSocket connection)
  // Add a small delay to ensure WebSocket is ready
  setTimeout(restoreRideFromSession, 500);
  
  // 5. Handle payment status from URL
  handlePaymentStatus();
  
  // 6. Initialize payment functionality
  setTimeout(initializePaymentFunctionality, 1000);

  // Form submission handler
  const rideForm = document.getElementById('rideForm');
  if (rideForm) {
      rideForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const currentLocation = document.getElementById('current-location').value;
          const destination = document.getElementById('destination').value;
          
          if (!currentLocation || !destination) {
              alert('Please enter both locations');
              return;
          }

          const fareEstimate = document.getElementById('fareEstimate');
          if (fareEstimate && fareEstimate.style.display === 'block') {
              bookRide(currentLocation, destination);
          } else {
              calculateFare();
          }
      });
  }

  // Cancel button handler
  const cancelBtn = document.getElementById('cancelRideBtn');
  if (cancelBtn) {
      cancelBtn.addEventListener('click', cancelRide);
  }
});


function loadGoogleMapsAPI() {
    // Check if already loaded
    if (window.google?.maps?.places) {
        console.log("Google Maps already loaded");
        initAutocomplete();
        return;
    }

    // Check if script is already being loaded
    if (document.querySelector('script[src*="maps.googleapis.com"]')) {
        console.log("Google Maps script already loading");
        return;
    }

    console.log("Loading Google Maps API...");
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=initAutocomplete`;
    script.async = true;
    script.defer = true;
    
    script.onerror = function() {
        console.error("Failed to load Google Maps API");
        showFallbackInputs();
    };
    
    script.onload = function() {
        console.log("Google Maps API script loaded successfully");
    };
    
    document.head.appendChild(script);
}

function showFallbackInputs() {
    console.log("Showing fallback inputs");
    const container = document.querySelector('.location-inputs');
    if (container) {
        container.innerHTML = `
            <input type="text" id="current-location" 
                   placeholder="Enter pickup location" 
                   class="fallback-input">
            <input type="text" id="destination" 
                   placeholder="Enter destination" 
                   class="fallback-input">
        `;
    }
}

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            func.apply(context, args);
        }, wait);
    };
}

// Error class for fare-specific errors
class FareError extends Error {
    constructor(message, statusCode) {
        super(message);
        this.statusCode = statusCode;
        this.name = 'FareError';
    }
}

function showErrorToast(message) {
    const existingToasts = document.querySelectorAll('.error-toast');
    existingToasts.forEach(toast => toast.remove());

    const toast = document.createElement('div');
    toast.className = 'error-toast';
    toast.innerHTML = `
        <i class="fas fa-exclamation-circle"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Main fare calculation function
async function calculateFare() {
    const pickupInput = document.getElementById('current-location');
    const destinationInput = document.getElementById('destination');
    
    if (!pickupInput || !destinationInput) {
        console.error('Location inputs not found');
        return;
    }

    const pickup = pickupInput.value;
    const destination = destinationInput.value;
    
    if (!pickup?.trim() || !destination?.trim()) {
        hideFareEstimate();
        return;
    }

    const submitBtn = document.querySelector('.submit-btn');
    setLoadingState(submitBtn, true);

    try {
        const response = await fetchFareEstimate(pickup, destination);
        const data = await processFareResponse(response);
        updateFareDisplay(data);
    } catch (error) {
        handleFareError(error);
    } finally {
        setLoadingState(submitBtn, false);
    }
}

// Fetch fare estimate from backend
async function fetchFareEstimate(pickup, destination) {
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) throw new FareError('Security token missing', 403);

    const response = await fetch('/api/estimate-fare/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            pickup: pickup.trim(),
            destination: destination.trim(),
            vehicle_type: 'standard',
            timestamp: Date.now()
        })
    });
    
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new FareError(
            errorData.error || errorData.message || 'Failed to calculate fare', 
            response.status
        );
    }
    return response;
}

// Process the fare response
async function processFareResponse(response) {
    const data = await response.json();
    
    // Validate response structure
    if (!data || 
        typeof data.total_fare === 'undefined' ||
        typeof data.distance_km === 'undefined' ||
        typeof data.duration_min === 'undefined') {
        throw new FareError('Invalid fare data received', 500);
    }
    
    return {
        total_fare: parseFloat(data.total_fare) || 0,
        distance_km: parseFloat(data.distance_km) || 0,
        duration_min: parseFloat(data.duration_min) || 0,
        surge_multiplier: parseFloat(data.surge_multiplier) || 1.0
    };
}

// Update the fare display
function updateFareDisplay(data) {
    const fareEstimate = document.getElementById('fareEstimate');
    if (!fareEstimate) return;

    // Format currency for Nigerian Naira
    const formatter = new Intl.NumberFormat('en-NG', {
        style: 'currency',
        currency: 'NGN',
        minimumFractionDigits: 2
    });

    // Update fare information
    const fareAmountEl = document.getElementById('fareAmount');
    const distanceTextEl = document.getElementById('distanceText');
    const durationTextEl = document.getElementById('durationText');
    
    if (fareAmountEl) fareAmountEl.textContent = formatter.format(data.total_fare);
    if (distanceTextEl) distanceTextEl.textContent = `${data.distance_km.toFixed(1)} km`;
    if (durationTextEl) durationTextEl.textContent = `${Math.round(data.duration_min)} mins`;

    // Handle surge pricing display
    const surgeNoticeEl = document.getElementById('surgeNotice');
    if (data.surge_multiplier > 1 && surgeNoticeEl) {
        const surgeMultiplierEl = document.getElementById('surgeMultiplier');
        if (surgeMultiplierEl) surgeMultiplierEl.textContent = data.surge_multiplier.toFixed(1);
        surgeNoticeEl.style.display = 'block';
    } else if (surgeNoticeEl) {
        surgeNoticeEl.style.display = 'none';
    }

    fareEstimate.style.display = 'block';
}

// Error handling
function handleFareError(error) {
    console.error('Fare calculation error:', error);
    hideFareEstimate();
    
    // Show error to user
    const errorMessage = error instanceof FareError 
        ? error.message
        : 'Failed to calculate fare. Please try again.';
    
    showErrorToast(errorMessage);
}

async function bookRide(currentLocation, destination) {
    console.log('[BOOK RIDE] Starting ride booking process');
    console.log('[BOOK RIDE] Pickup:', currentLocation);
    console.log('[BOOK RIDE] Destination:', destination);
    
    const submitBtn = document.querySelector('.submit-btn');
    if (!submitBtn) {
        console.error('Submit button not found');
        return;
    }

    // Validate inputs
    if (!currentLocation?.trim() || !destination?.trim()) {
        showErrorToast('Please enter both pickup and destination locations');
        return;
    }

    // Set loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Booking...';

    try {
        const csrfToken = getCookie('csrftoken');
        if (!csrfToken) {
            throw new Error('Security token missing. Please refresh the page.');
        }

        const response = await fetch('/request_ride/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                current_location: currentLocation.trim(),
                destination: destination.trim(),
                timestamp: Date.now()
            })
        });

        // Handle HTTP errors
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
                errorData.error || 
                errorData.message || 
                `Booking failed (Status: ${response.status})`
            );
        }

        const data = await response.json();
        
        // Validate response structure
        if (!data.ride_id) {
            throw new Error('Invalid response from server: Missing ride ID');
        }
        
        console.log('[BOOK RIDE] Success! Ride ID:', data.ride_id);
        console.log('[BOOK RIDE] Initiating ride tracking...');

        // Start tracking the ride
        startRideTracking(data.ride_id);
        
    } catch (error) {
        console.error('Booking error:', error);
        
        // Show user-friendly error messages
        const errorMessage = error.message.includes('Failed to fetch') 
            ? 'Network error. Please check your connection.'
            : error.message;
            
        showErrorToast(errorMessage);
        
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Book a Ride';
    }
}

function startRideTracking(rideId) {
    console.log('[RIDE TRACKING] Starting ride tracking for ride ID:', rideId);
    currentRideId = rideId;

    // Safely get all elements
    const rideForm = document.getElementById('rideForm');
    const trackingCard = document.getElementById('rideTrackingCard');
    const trackingCodeElement = document.getElementById('trackingCode');
    const searchingState = document.getElementById('searchingState');
    const assignedState = document.getElementById('driverAssignedState');
    
    // Check elements exist before using them
    if (!rideForm || !trackingCard || !searchingState || !assignedState) {
        console.error("Missing required elements in DOM");
        showErrorToast("Error initializing ride tracking");
        return;
    }
    
    // Update UI
    console.log('[RIDE TRACKING] Updating UI for new ride');
    rideForm.style.display = 'none';
    trackingCard.style.display = 'block';
    
    if (trackingCodeElement) {
        trackingCodeElement.textContent = Math.random().toString(36).substring(2, 6).toUpperCase();
    }
    
    searchingState.style.display = 'block';
    assignedState.style.display = 'none';
    console.log('[RIDE TRACKING] UI updated - showing searching state');
    
    // Start tracking
    console.log('[RIDE TRACKING] Subscribing to ride updates');
    subscribeToRide(rideId);
    checkRideStatus();
    clearInterval(rideStatusInterval);
    rideStatusInterval = setInterval(checkRideStatus, 3000);
    console.log('[RIDE TRACKING] Started status polling interval');
}

async function checkRideStatus() {
    console.log('[STATUS CHECK] Checking status for ride:', currentRideId);
    if (!currentRideId) {
        console.warn('[STATUS CHECK] No current ride ID');
        return;
    } 

    try {
        console.log('[STATUS CHECK] Making API request to /ride-status/' + currentRideId + '/');
        const response = await fetch(`/ride-status/${currentRideId}/`);
        
        if (!response.ok) {
            console.error('[STATUS CHECK] API request failed with status:', response.status);
            throw new Error('Failed to check status');
        } 
        
        const data = await response.json();
        updateRideStatusUI(data);
        
        if (['completed', 'cancelled'].includes(data.status)) {
            clearInterval(rideStatusInterval);
        }
    } catch (error) {
        console.error('Status check error:', error);
    }
}

// Enhanced updateRideStatusUI to handle all states properly
function updateRideStatusUI(data) {
  console.log('[UI UPDATE] Updating UI with data:', data);
  
  const statusElement = document.getElementById('trackingStatus');
  const searchingState = document.getElementById('searchingState');
  const assignedState = document.getElementById('driverAssignedState');
  const completedState = document.getElementById('tripCompletedState');
  const cancelButton = document.getElementById('cancelRideBtn');
  const payNowButton = document.getElementById('payNowBtn');
  const paymentProcessingBtn = document.getElementById('paymentProcessingBtn');
  const paymentCompletedState = document.getElementById('paymentCompletedState');

  if (!statusElement) {
      console.error('[UI UPDATE] Status element not found');
      return;
  }

  // Hide all states first
  if (searchingState) searchingState.style.display = 'none';
  if (assignedState) assignedState.style.display = 'none';
  if (completedState) completedState.style.display = 'none';
  if (payNowButton) payNowButton.style.display = 'none';
  if (paymentProcessingBtn) paymentProcessingBtn.style.display = 'none';
  if (paymentCompletedState) paymentCompletedState.style.display = 'none';

  switch(data.status) {
      case 'pending':
          console.log('[UI UPDATE] Showing pending state');
          statusElement.textContent = "Finding you a driver";
          if (searchingState) searchingState.style.display = 'block';
          if (cancelButton) cancelButton.style.display = 'block';
          break;
          
      case 'accepted':
          console.log('[UI UPDATE] Showing accepted state');
          statusElement.textContent = "Driver is on the way!";
          if (assignedState) assignedState.style.display = 'block';
          if (cancelButton) cancelButton.style.display = 'block';
          
          if (data.driver) {
              const driverNameEl = document.getElementById('driverName');
              const vehicleInfoEl = document.getElementById('vehicleInfo');
              
              if (driverNameEl) driverNameEl.textContent = data.driver.name || "Driver assigned";
              if (vehicleInfoEl) vehicleInfoEl.textContent = data.driver.car_model && data.driver.license_plate 
                  ? `${data.driver.car_model} • ${data.driver.license_plate}`
                  : "Vehicle details coming soon";
                  
              updateStarRating(data.driver.rating || 4.5);
          }
          
          const estimatedArrivalEl = document.getElementById('estimatedArrival');
          if (estimatedArrivalEl) {
              estimatedArrivalEl.textContent = data.eta ? `ETA: ${data.eta} min` : "Calculating arrival time...";
          }
          break;
          
      case 'started':
          console.log('[UI UPDATE] Showing started state');
          statusElement.textContent = "Trip in progress";
          if (assignedState) assignedState.style.display = 'block';
          if (cancelButton) cancelButton.style.display = 'none';
          
          const estimatedArrivalEl2 = document.getElementById('estimatedArrival');
          if (estimatedArrivalEl2) estimatedArrivalEl2.textContent = "En route to destination";
          break;
          
      case 'completed':
          console.log('[UI UPDATE] Showing completed state');
          statusElement.textContent = "Trip Complete";
          if (completedState) completedState.style.display = 'block';
          if (cancelButton) cancelButton.style.display = 'none';
          
          // Update completed state information
          const completedFareEl = document.getElementById('completedFareAmount');
          const completedDriverNameEl = document.getElementById('completedDriverName');
          const completedVehicleInfoEl = document.getElementById('completedVehicleInfo');
          const payNowAmountEl = document.getElementById('payNowAmount');
          
          const fareAmount = data.fare || COMPLETED_RIDE_FARE || 0;
          if (completedFareEl) completedFareEl.textContent = fareAmount.toFixed(2);
          if (payNowAmountEl) payNowAmountEl.textContent = fareAmount.toFixed(2);
          
          const driverData = data.driver || CURRENT_DRIVER;
          if (driverData) {
              if (completedDriverNameEl) completedDriverNameEl.textContent = driverData.name || "Driver";
              if (completedVehicleInfoEl) completedVehicleInfoEl.textContent = driverData.car_model && driverData.license_plate 
                  ? `${driverData.car_model} • ${driverData.license_plate}`
                  : "Vehicle info";
          }
          
          // Show payment button or completed state
          if (data.payment_status === 'paid') {
              console.log('[UI UPDATE] Payment already completed');
              if (paymentCompletedState) paymentCompletedState.style.display = 'block';
          } else {
              console.log('[UI UPDATE] Showing pay now button');
              if (payNowButton) {
                  payNowButton.style.display = 'block';
                  payNowButton.setAttribute('data-ride-id', currentRideId);
                  payNowButton.setAttribute('data-amount', fareAmount);
              }
          }
          break;
          
      case 'cancelled':
          console.log('[UI UPDATE] Showing cancelled state');
          statusElement.textContent = "Trip cancelled";
          statusElement.style.color = "red";
          if (cancelButton) cancelButton.style.display = 'none';
          
          // Clear session and show form after a delay
          setTimeout(() => {
              showRideForm();
              currentRideId = null;
          }, 3000);
          break;
  }
}


function updateStarRating(rating) {
    const ratingElement = document.querySelector('.driver-rating');
    if (ratingElement && rating) {
        ratingElement.innerHTML = '';
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        
        for (let i = 0; i < 5; i++) {
            const star = document.createElement('i');
            if (i < fullStars) {
                star.className = 'fas fa-star';
            } else if (i === fullStars && hasHalfStar) {
                star.className = 'fas fa-star-half-alt';
            } else {
                star.className = 'far fa-star';
            }
            ratingElement.appendChild(star);
        }
    }
}

async function cancelRide() {
  if (!currentRideId || !confirm('Are you sure you want to cancel this ride?')) return;
  
  const cancelButton = document.getElementById('cancelRideBtn');
  if (cancelButton) cancelButton.disabled = true;
  
  try {
      const response = await fetch(`/cancel-ride/${currentRideId}/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'same-origin'
      });
      
      if (response.ok) {
        
        updateRideStatusUI({ status: 'cancelled' });
        hideRideTrackingCard();
        
        clearInterval(rideStatusInterval);
        
        if (rideSocket && rideSocket.readyState === WebSocket.OPEN) {
            rideSocket.send(JSON.stringify({
                action: 'unsubscribe',
                ride_id: currentRideId
            }));
        }
    } else {
        throw new Error('Failed to cancel ride');
    }
      
  } catch (error) {
      console.error('Cancel error:', error);
      showErrorToast(error.message);
  } finally {
      const cancelButton = document.getElementById('cancelRideBtn');
      if (cancelButton) cancelButton.disabled = false;
  }
}


function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add event listener for Pay Now button
document.addEventListener('DOMContentLoaded', function() {
  // ... your existing code
  
  // Pay Now button handler
  document.getElementById('payNowBtn').addEventListener('click', function() {
      const rideId = this.getAttribute('data-ride-id');
      const amount = this.getAttribute('data-amount');
      
      // Show processing state
      this.style.display = 'none';
      document.getElementById('paymentProcessingBtn').style.display = 'block';
      
      // Initiate payment
      initiatePaystackPayment(rideId);
  });
});

// Update your initiatePaystackPayment function
async function initiatePaystackPayment(rideId) {
  try {
      const response = await fetch(`/initiate-payment/${rideId}/`, {
          method: 'POST',
          headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'X-Requested-With': 'XMLHttpRequest'
          }
      });

      const data = await response.json();
      
      if (data.status === 'success' && data.payment_url) {
          // Redirect to Paystack
          window.location.href = data.payment_url;
      } else {
          throw new Error(data.error || 'Failed to initiate payment');
      }
  } catch (error) {
      console.error('Payment initiation error:', error);
      alert('Failed to initiate payment: ' + error.message);
      
      // Reset button states
      document.getElementById('paymentProcessingBtn').style.display = 'none';
      document.getElementById('payNowBtn').style.display = 'block';
  }
}

// Payment status handler - add this to your rider dashboard JavaScript
function handlePaymentStatus() {
  const urlParams = new URLSearchParams(window.location.search);
  const paymentStatus = urlParams.get('payment');
  const amount = urlParams.get('amount');
  const rideId = urlParams.get('ride_id');

  if (paymentStatus === 'success') {
      // Show success message
      showPaymentSuccessMessage(amount);
      
      // Refresh completed rides to show updated payment status
      updateRiderCompletedRides();
      
      // Remove the parameters from URL (clean URL)
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
      
  } else if (paymentStatus === 'failed') {
      // Show error message
      showPaymentErrorMessage();
      
      // Remove the parameters from URL
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
  }
}

function showPaymentSuccessMessage(amount) {
  // Create success toast
  const toast = document.createElement('div');
  toast.className = 'payment-success-toast';
  toast.innerHTML = `
      <div class="toast-content">
          <i class="fas fa-check-circle"></i>
          <div class="toast-text">
              <strong>Payment Successful!</strong>
              <span>₦${parseFloat(amount).toFixed(2)} paid successfully</span>
          </div>
          <button class="toast-close">&times;</button>
      </div>
  `;
  
  document.body.appendChild(toast);
  
  // Add close button functionality
  const closeBtn = toast.querySelector('.toast-close');
  closeBtn.addEventListener('click', () => {
      toast.remove();
  });
  
  // Auto remove after 5 seconds
  setTimeout(() => {
      if (toast.parentNode) {
          toast.remove();
      }
  }, 5000);
}

function showPaymentErrorMessage() {
  // Create error toast
  const toast = document.createElement('div');
  toast.className = 'payment-error-toast';
  toast.innerHTML = `
      <div class="toast-content">
          <i class="fas fa-exclamation-circle"></i>
          <div class="toast-text">
              <strong>Payment Failed</strong>
              <span>Please try again or contact support</span>
          </div>
          <button class="toast-close">&times;</button>
      </div>
  `;
  
  document.body.appendChild(toast);
  
  // Add close button functionality
  const closeBtn = toast.querySelector('.toast-close');
  closeBtn.addEventListener('click', () => {
      toast.remove();
  });
  
  // Auto remove after 5 seconds
  setTimeout(() => {
      if (toast.parentNode) {
          toast.remove();
      }
  }, 5000);
}

// Update your existing updateRiderCompletedRides function
function updateRiderCompletedRides() {
  fetch('/rider/completed-rides/', {
      headers: {
          'X-Requested-With': 'XMLHttpRequest'
      }
  })
  .then(response => response.json())
  .then(data => {
      const container = document.getElementById('completedRidesContainer');
      if (container) {
          container.innerHTML = data.html;
      }
  })
  .catch(error => {
      console.error('Error updating rider completed rides:', error);
  });
}

// Call this when the page loads
document.addEventListener('DOMContentLoaded', function() {
  // Your existing DOMContentLoaded code...
  
  // Handle payment status from URL parameters
  handlePaymentStatus();
  
  // Initialize payment functionality
  setTimeout(initializePaymentFunctionality, 1000);
});

// Add initialization function for payment
function initializePaymentFunctionality() {
  const payNowBtn = document.getElementById('payNowBtn');
  if (payNowBtn && !payNowBtn.hasAttribute('data-initialized')) {
      payNowBtn.setAttribute('data-initialized', 'true');
      payNowBtn.addEventListener('click', function() {
          const rideId = this.getAttribute('data-ride-id');
          const amount = this.getAttribute('data-amount');
          
          console.log('[PAYMENT] Initiating payment for ride:', rideId);
          
          // Show processing state
          this.style.display = 'none';
          const processingBtn = document.getElementById('paymentProcessingBtn');
          if (processingBtn) processingBtn.style.display = 'block';
          
          // Initiate payment
          initiatePaystackPayment(rideId);
      });
  }
}
  </script>
</body>
</html>